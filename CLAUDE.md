# CLAUDE.md - TickStock Development Assistant Guide

**Important** - CLAUDE documentation is stored local at ./.claude-code-docs to reference not having to go out to anthropic to find documentation. This is kept current daily.

## CRITICAL RULES (ALWAYS FOLLOW)

- **ALWAYS** run integration tests before commits and when finalizing a sprint or phase of a sprint: `python run_tests.py`
- **ALWAYS** use specialized agents for development tasks (see Agent Usage below)
- **NEVER** mix typed events and dicts after Worker boundary
- **NEVER** reproduce copyrighted content (max 15 words from sources)
- **FIX IT RIGHT** - No band-aids, fix root causes only
- **NEVER** place Generated by Claude comments in code or commits 

## Quick Actions

**Need to implement a feature?**
1. Search project knowledge: What already exists?
2. Check agent triggers: Which agents are needed?
3. Validate approach: Run `architecture-validation-specialist`
4. Implement with tests: Use domain specialists
5. Verify: Run integration tests

**Common Commands**
```bash
# Run tests (MANDATORY before commits)
python run_tests.py

# Alternative test command
python tests/integration/run_integration_tests.py

# Check project structure
python scripts/dev_tools/generate_structure.py

# Database migrations
python model_migrations_run.py migrate "Description"
python model_migrations_run.py upgrade

# Start application
python start_both_services.py
```

## Architecture Essentials

**TickStock.ai** is a high-performance platform for real-time and batch processing of market data, analyzing over 4,000 stock symbols with sub-millisecond efficiency. It leverages a three-tiered architectureâ€”Daily Batch Processing, Intraday Streaming, and Combo Hybrid Intelligenceâ€”to detect technical patterns (e.g., Doji, breakouts) and calculate indicators (e.g., RSI, MACD) across intraday, hourly, daily, weekly, and monthly timeframes. Built with Python (pandas, NumPy, SciPy), it integrates Polygon API data and supports modular expansion via a dynamic loading system (NO FALLBACK policy).

**Components:**
- **TickStockAppV2**: Manages UI, authentication, and real-time WebSocket updates; consumes events and triggers jobs via Redis.
- **TickStockPL**: Handles pattern detection, data processing, backtesting, and TimescaleDB management; publishes events to Redis.

**Key Features:**
- Processes thousands of symbols/minute for intraday patterns/indicators
- Performs daily batch analysis for long-term trends, stored in TimescaleDB
- Correlates multi-timeframe signals with fundamentals (e.g., EPS surprises) for <5% false positives
- Achieves >300 symbols/second, >92% cache hit rates, with Flask, SQLAlchemy, and Matplotlib integration

**Redis Pub-Sub**: Ensures loose coupling between components, with channels like tickstock.events.patterns and tickstock:monitoring for real-time events and metrics.



### Code Quality Standards

#### Structure Limits (ENFORCE)
- **Files**: Max 500 lines per file
- **Functions**: Max 50 lines per function
- **Classes**: Max 500 lines per class
- **Line Length**: Max 100 characters
- **Complexity**: Cyclomatic complexity <10

#### Naming Conventions
- **Variables/Functions**: snake_case (e.g., `process_pattern`)
- **Classes**: PascalCase (e.g., `PatternProcessor`)
- **Constants**: UPPER_SNAKE_CASE (e.g., `MAX_RETRIES`)
- **Private**: Prefix with underscore (e.g., `_internal_method`)

#### Development Principles
- **KISS**: Keep It Simple - choose straightforward solutions
- **YAGNI**: You Aren't Gonna Need It - avoid speculative features
- **DRY**: Don't Repeat Yourself - abstract common functionality
- **Fail Fast**: Check errors early, raise exceptions immediately
- **Single Responsibility**: Each component has one clear purpose

### Performance Targets (NON-NEGOTIABLE)

| Operation | Target | Critical Path |
|-----------|--------|---------------|
| Symbol Processing | <1ms | Yes |
| WebSocket Delivery | <100ms | Yes |
| API Response | <50ms | Yes |
| Database Query | <50ms | No |
| Redis Operation | <10ms | Yes |

## Agent Usage

### Auto-Trigger Decision Tree
```
START
  â†“
Is it a new task? â†’ YES â†’ architecture-validation-specialist (FIRST)
  â†“ NO
What are you modifying?
  â”œâ”€â”€ src/processing/* â†’ tickstock-test-specialist + architecture
  â”œâ”€â”€ src/database/* â†’ database-query-specialist + architecture
  â”œâ”€â”€ src/redis/* â†’ redis-integration-specialist + integration-testing
  â”œâ”€â”€ src/api/* â†’ appv2-integration-specialist + database-query
  â”œâ”€â”€ Security-related â†’ code-security-specialist (MANDATORY)
  â””â”€â”€ Documentation â†’ documentation-sync-specialist

ALWAYS END WITH â†’ integration-testing-specialist (MANDATORY)
```

### Quick Agent Reference

| Task Type | Required Agent Workflow |
|-----------|-------------------------|
| New Feature | architecture â†’ domain â†’ test â†’ integration â†’ documentation |
| Bug Fix | domain â†’ test â†’ integration |
| Database Change | database â†’ architecture â†’ test |
| Redis Integration | redis â†’ integration â†’ test |
| UI/API Work | appv2 â†’ database â†’ test |
| Security Updates | security â†’ architecture â†’ test |

## Project Quick Map

### Critical Paths
```
config/          # Application configuration
web/            # Flask templates and static files
src/            # Core application code
tests/          # Test suites
docs/           # Documentation (streamlined)
.claude/agents/ # Specialized AI agents
```

### Key Documentation
- `docs/README.md` - Documentation overview
- `docs/about_tickstock.md` - Platform capabilities
- `docs/architecture/README.md` - System architecture
- `docs/guides/quickstart.md` - Getting started
- `docs/guides/configuration.md` - Configuration reference
- `docs/guides/testing.md` - Testing guide
- `docs/api/endpoints.md` - API documentation

## Sprint Development 
### Phase 1: Analysis (REQUIRED)
- Understand sprint goal and requirements
- Search project knowledge for existing code
- Run architecture-validation-specialist
- Identify all required agents
- Get explicit approval before coding

### Phase 2: Implementation (MANDATORY)
- Follow 500 lines/file, 50 lines/function limits
- Use domain specialists for guidance
- Add comprehensive error handling 
- Write tests alongside code

### Phase 3: Validation (MANDATORY)
- Run integration tests: python run_tests.py
- Verify performance targets met
- Run code-security-specialist if security-related
- Check for hardcoded credentials
- Ensure no copyright violations

### Phase 4: Completion
- Update documentation if needed
- Summarize accomplishments 
- Remove ALL "Generated by Claude" text
- Commit with proper format (no AI attributions)
- Track remaining tasks for next sprint

## Current Sprint Context
- `docs/planning/sprints/` - Sprint documentation (user-managed)
- `docs/planning/sprints/BACKLOG.md` - Future work items

## ðŸ“Š Database & Configuration

### Database Access
```python
# Read-only user for application
User: app_readwrite
# NEVER query pattern tables directly - use Redis cache
# Pattern data comes via Redis pub-sub from TickStockPL
```

### Environment Variables (.env)
```bash
# Logging
LOG_FILE_ENABLED=true
LOG_FILE_PATH=logs/tickstock.log
LOG_DB_ENABLED=true
LOG_DB_SEVERITY_THRESHOLD=error

# Redis
REDIS_ERROR_CHANNEL=tickstock:errors
REDIS_PATTERN_CHANNEL=tickstock.events.patterns

# Tracing (for debug panel)
TRACE_ENABLED=true
TRACE_TICKERS=["NVDA", "TSLA", "AAPL"]
TRACE_LEVEL=VERBOSE
```

## Common Pitfalls & Solutions
| Pitfall | Solution |
|---------|----------|
| Mixing event types after Worker | Always convert to dict at Worker boundary |
| Database queries in hot path | Use Redis or in-memory cache |
| Skipping tests | Integration tests are MANDATORY |
| Hardcoded credentials | Use environment variables only |
| Large functions | Max 50 lines per function |
| Copyright violations | Max 15 words from sources, with quotes |
| Mock endpoints in production | Remove ALL mock/test endpoints |

## Production Requirements

### MANDATORY Before Deployment
- âœ… All integration tests passing
- âœ… No mock endpoints or hardcoded data
- âœ… Redis pub-sub connected to TickStockPL
- âœ… Performance targets achieved (<1ms tick, <100ms WebSocket)
- âœ… Security scan completed (no hardcoded passwords)
- âœ… 90%+ test coverage on critical components

## Communication Protocol
**When working on tasks:**
1. **Confirm understanding** - Restate the goal
2. **Analyze approach** - Summarize strategy with agent recommendations
3. **Ask clarifications** - Get answers BEFORE coding
4. **Implement** - Use agent workflow throughout
5. **Validate** - Run all required tests
6. **Document** - Update relevant documentation
7. **Document Completion** - Update completion summary

_This document is a living guide. Update it as the project evolves and new patterns emerge._