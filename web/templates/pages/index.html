<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TickStock.ai</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/utilities/main.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.0/socket.io.min.js"></script>
    <!-- Chart.js Integration -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@10.0.1/dist/gridstack.min.css">
    <script src="https://cdn.jsdelivr.net/npm/gridstack@10.0.1/dist/gridstack-all.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // üÜï SPRINT 1D.5: User context for per-user universe selection - SAFE STRING OUTPUT
        window.userContext = {
            username: "{{ username }}",
            isAuthenticated: "{{ current_user.is_authenticated|lower }}" === "true",
            userId: null // Will be populated from API response
        };
        
        // üÜï CSRF Token for API calls
        window.csrfToken = "{{ csrf_token() }}";
    </script>
</head>
<body>
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <!-- Navigation Bar -->
    <div class="navbar">
        <div class="navbar-left">
            <img src="{{ url_for('static', filename='images/logo-placeholder.jpg') }}" alt="TickStock.ai Logo" class="navbar-logo" />
            <h1>TickStock.ai</h1>
        </div>
        <div class="navbar-right">
            <!-- Market Status -->
            <span id="market-status" class="status-badge">Loading...</span>
            
            <!-- Connection Status -->
            <div id="connection-status" class="connection-indicator">
                <span class="connection-dot"></span>
                <span class="connection-text">Connected</span>
            </div>
            
            <!-- Settings buttons container -->
            <div class="navbar-settings">
                <!-- Universe Selection -->
                <button class="navbar-btn universe-btn" data-tracker="highlow" title="Select Your Personal Universe">
                    <span class="settings-icon">üåê</span>
                    <span class="settings-text">Universe</span>
                </button>
                
                <!-- User Filters -->
                <button class="navbar-btn filters-btn" id="openFiltersModalBtn" title="Configure Data Filters">
                    <span class="settings-icon">üîß</span>
                    <span class="settings-text">Filters</span>
                </button>
                
                <!-- User Settings Dropdown -->
                <div class="user-menu">
                    <button class="navbar-btn user-settings-btn" aria-expanded="false" aria-haspopup="true">
                        <span class="settings-icon">‚öôÔ∏è</span>
                        <span class="settings-text">User Settings</span>
                    </button>
                    <div class="dropdown-content">
                        <a href="{{ url_for('account') }}">Account</a>
                        <a href="{{ url_for('subscription') }}">Subscription</a>
                        <a href="{{ url_for('change_password') }}">Change Password</a>
                        <a href="mailto:support@tickstock.com">support@tickstock.com</a>
                        <a href="{{ url_for('logout') }}">Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="error-message" style="display: none;"></div>
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <!-- MAIN CONTENT SECTION - REORGANIZED FOR SPRINT S14 -->
        <main class="grid-stack" id="grid-container">
            
            <!-- 1. Activity Velocity Dashboard (Replaces Gauge) -->
            <div class="grid-stack-item" 
                data-gs-width="6" 
                data-gs-height="3"
                data-gs-id="core-gauge"
                data-gs-min-width="8" data-gs-min-height="5">
                <div class="grid-stack-item-content">
                    <div class="velocity-dashboard-container" id="core-gauge-container">
                        <!-- Dashboard content will be injected by JavaScript -->
                    </div>
                </div>
            </div>

            
            <!-- 3. High/Low Percentage Bar -->
            <div class="grid-stack-item" 
                data-gs-width="12" 
                data-gs-height="2" 
                data-gs-id="percentage-bar"
                data-gs-min-height="2">
                <div class="grid-stack-item-content">
                    <div class="percentage-bar-section">
                        <h3>High/Low Market Breadth Indicator</h3>
                        <div class="bar-row percentage-bars">
                            <div id="unified-percent-bar" class="unified-bar">
                                <div id="high-percent-fill" class="high-fill"></div>
                                <div id="low-percent-fill" class="low-fill"></div>
                                <div id="high-percent-label" class="high-label"></div>
                                <div id="low-percent-label" class="low-label"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid-stack-item" data-gs-width="6" data-gs-height="4" data-gs-id="lows">
                <div class="grid-stack-item-content">
                    <!-- 4. Lows Section -->
                    <div class="lows-section">
                        <h3>
                            New Lows
                            <span id="low-percent-text" class="debug-text-text"></span>
                        </h3>
                        <div class="events-header-container" id="lows-header-container">
                            <div class="events-header-row highs-lows-header">
                                <span class="header-count">Count</span>
                                <span class="header-ticker">Ticker</span>
                                <span class="header-price">Price</span>
                                <span class="header-change">Chng%</span>
                                <span class="header-vwap-distance">Dist VWAP%</span>
                                <span class="header-volume">Volume</span>
                                <span class="header-label">Label</span>
                                <span class="header-time">Time</span>
                            </div>
                        </div>
                        <div id="lows-list" class="events-list"></div>
                    </div>
                </div>
            </div>


            <div class="grid-stack-item" data-gs-width="6" data-gs-height="4" data-gs-id="highs">
                <div class="grid-stack-item-content">
                    <!-- 5. Highs Section -->
                    <div class="highs-section">
                        <h3>
                            New Highs
                            <span id="high-percent-text" class="debug-text-text"></span>
                        </h3>
                        <div class="events-header-container" id="highs-header-container">
                            <div class="events-header-row highs-lows-header">
                                <span class="header-count">Count</span>
                                <span class="header-ticker">Ticker</span>
                                <span class="header-price">Price</span>
                                <span class="header-change">Chng%</span>
                                <span class="header-vwap-distance">Dist VWAP%</span>
                                <span class="header-volume">Volume</span>
                                <span class="header-label">Label</span>
                                <span class="header-time">Time</span>
                            </div>
                        </div>
                        <div id="highs-list" class="events-list"></div>
                    </div>
                </div>  
            </div>

            <div class="grid-stack-item" data-gs-width="6" data-gs-height="4" data-gs-id="uptrend">
                <div class="grid-stack-item-content">
                    <div class="trends-surges uptrend-section">
                        <h3>Uptrend Stocks <span id="uptrend-count-text"></span></h3>
                        <div class="events-header-container" id="uptrend-header-container">
                            <div class="events-header-row trending-surging-header">
                                <span class="header-direction"></span> <!-- Empty but present -->
                                <span class="header-count">Count</span>
                                <span class="header-ticker">Ticker</span>
                                <span class="header-price">Price</span>
                                <span class="header-change">Chng%</span>
                                <span class="header-vwap-distance">Dist VWAP%</span>
                                <span class="header-volume">Volume</span>
                                <span class="header-label">Label</span>
                                <span class="header-time">Time</span>
                            </div>
                        </div>
                        <div id="uptrend-list" class="events-list"></div>
                    </div>
                </div>
            </div>

            <div class="grid-stack-item" data-gs-width="6" data-gs-height="4" data-gs-id="downtrend">
                <div class="grid-stack-item-content">
                    <div class="trends-surges downtrend-section">
                        <h3>Downtrend Stocks <span id="downtrend-count-text"></span></h3>
                        <div class="events-header-container" id="downtrend-header-container">
                            <div class="events-header-row trending-surging-header">
                                <span class="header-direction"></span> <!-- Empty but present -->
                                <span class="header-count">Count</span>
                                <span class="header-ticker">Ticker</span>
                                <span class="header-price">Price</span>
                                <span class="header-change">Chng%</span>
                                <span class="header-vwap-distance">Dist VWAP%</span>
                                <span class="header-volume">Volume</span>
                                <span class="header-label">Label</span>
                                <span class="header-time">Time</span>
                            </div>
                        </div>
                        <div id="downtrend-list" class="events-list"></div>
                    </div>
                </div>  
            </div>

            <div class="grid-stack-item" data-gs-width="6" data-gs-height="4" data-gs-id="surging-up">
                <div class="grid-stack-item-content">
                    <div class="trends-surges surging-up-section">
                        <h3>Surging Up <span id="surging-up-count-text"></span></h3>
                        <div class="events-header-container" id="surging-up-header-container">
                            <div class="events-header-row trending-surging-header">
                                <span class="header-direction"></span> <!-- Empty but present -->
                                <span class="header-count">Count</span>
                                <span class="header-ticker">Ticker</span>
                                <span class="header-price">Price</span>
                                <span class="header-change">Chng%</span>
                                <span class="header-vwap-distance">Dist VWAP%</span>
                                <span class="header-volume">Volume</span>
                                <span class="header-label">Label</span>
                                <span class="header-time">Time</span>
                            </div>
                        </div>
                        <div id="surging-up-list" class="events-list"></div>
                    </div>
                </div>
            </div>


            <div class="grid-stack-item" data-gs-width="6" data-gs-height="4" data-gs-id="surging-down">
                <div class="grid-stack-item-content">
                    <div class="trends-surges surging-down-section">
                        <h3>Surging Down <span id="surging-down-count-text"></span></h3>
                        <div class="events-header-container" id="surging-down-header-container">
                            <div class="events-header-row trending-surging-header">
                                <span class="header-direction"></span> <!-- Empty but present -->
                                <span class="header-count">Count</span>
                                <span class="header-ticker">Ticker</span>
                                <span class="header-price">Price</span>
                                <span class="header-change">Chng%</span>
                                <span class="header-vwap-distance">Dist VWAP%</span>
                                <span class="header-volume">Volume</span>
                                <span class="header-label">Label</span>
                                <span class="header-time">Time</span>
                            </div>
                        </div>
                        <div id="surging-down-list" class="events-list"></div>
                    </div>
                </div>
            </div>

        </main>

    </div>

    <!-- Status Bar - Consolidated -->
    <div class="status-bar">
        <div class="status-bar-left">
            <div class="status-bar-item">
                <span class="status-label">Version:</span>
                <span id="app-version">{{ config.APP_VERSION }}</span>
            </div>
            <div class="status-bar-item">
                <span class="status-label">User:</span>
                <span id="status-username">{{ username }}</span>
            </div>
        </div>
        <div class="status-bar-right">
            <div class="status-bar-controls">
                <button id="grid-edit-btn" class="status-bar-btn save-btn">
                    <span class="btn-icon">üîì</span>
                    <span class="btn-text">Edit Layout</span>
                </button>
                <button id="grid-reset-btn" class="status-bar-btn reset-btn">
                    <span class="btn-icon">‚Ü∫</span>
                    <span class="btn-text">Reset Layout</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- üÜï SPRINT 1D.5: Enhanced Universe Selection Modal with User Context -->
    <div id="universeSelectionModal" class="modal universe-modal">
        <div class="modal-content universe-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Select Your Stock Universes</h3>
                <span class="close universe-modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="universe-info">
                    <p><strong>{{ username }}</strong>, select which stock universes to monitor for your personalized events. The TickStock Core universe (2,800 stocks) is always active.</p>
                    <div class="user-context-info">
                        <small>Your selection will be saved to your account and applied immediately.</small>
                    </div>
                </div>
                
                <div class="universe-options">
                    <div class="universe-section">
                        <h4>Available User Universes</h4>
                        <div class="universe-checkboxes">
                            <label class="universe-checkbox-label">
                                <input type="checkbox" class="universe-checkbox" value="DEFAULT_UNIVERSE" checked>
                                <div class="universe-details">
                                    <span class="universe-name">Default Universe</span>
                                    <span class="universe-count">(762 stocks)</span>
                                    <p class="universe-description">Balanced selection across market caps and sectors</p>
                                </div>
                            </label>
                            
                            <label class="universe-checkbox-label">
                                <input type="checkbox" class="universe-checkbox" value="MARKET_CAP_LARGE_UNIVERSE">
                                <div class="universe-details">
                                    <span class="universe-name">Large Cap Universe</span>
                                    <span class="universe-count">(545 stocks)</span>
                                    <p class="universe-description">Large capitalization stocks with high liquidity</p>
                                </div>
                            </label>
                            
                            <label class="universe-checkbox-label">
                                <input type="checkbox" class="universe-checkbox" value="MARKET_CAP_MID_UNIVERSE">
                                <div class="universe-details">
                                    <span class="universe-name">Mid Cap Universe</span>
                                    <span class="universe-count">(1000 stocks)</span>
                                    <p class="universe-description">Mid capitalization stocks with growth potential</p>
                                </div>
                            </label>
                            
                            <label class="universe-checkbox-label">
                                <input type="checkbox" class="universe-checkbox" value="LEADER_UNIVERSE">
                                <div class="universe-details">
                                    <span class="universe-name">Market Leaders Universe</span>
                                    <span class="universe-count">(500 stocks)</span>
                                    <p class="universe-description">Industry leaders and market-moving stocks</p>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="universe-summary">
                        <div class="selected-summary">
                            <h4>Your Selection Summary</h4>
                            <div class="summary-stats">
                                <div class="stat-item">
                                    <span class="stat-label">Total Stocks:</span>
                                    <span id="total-stocks-count" class="stat-value">762</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Unique Stocks:</span>
                                    <span id="unique-stocks-count" class="stat-value">762</span>
                                    <span class="stat-note">(after removing duplicates)</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Performance Impact:</span>
                                    <span id="performance-warning" class="stat-value good">Optimal</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button id="applyUniverseSelection" class="btn btn-primary">Apply My Selection</button>
                <button id="cancelUniverseSelection" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- User Filters Modal -->
    <div id="userFiltersModal" class="modal filter-modal" aria-hidden="true">
        <div class="modal-content filter-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">My Data Filters</h3>
                <span class="close filter-modal-close" aria-label="Close">&times;</span>
            </div>
            
            <div class="modal-body filter-modal-body">
                <!-- High/Low Event Filters -->
                <div class="filter-section highlow-filters">
                    <h4>High/Low Event Filters</h4>
                    
                    <div class="filter-group">
                        <label class="filter-label" for="highlow-min-count">Minimum Count</label>
                        <select class="filter-select" id="highlow-min-count">
                            <option value="0" selected>No Minimum</option>
                            <option value="10">10 or more</option>
                            <option value="25">25 or more</option>
                            <option value="50">50 or more</option>
                            <option value="75">75 or more</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label" for="highlow-min-volume">Minimum Volume</label>
                        <select class="filter-select" id="highlow-min-volume">
                            <option value="0" selected>No Minimum</option>
                            <option value="50000">50K+</option>
                            <option value="100000">100K+</option>
                            <option value="250000">250K+</option>
                            <option value="500000">500K+</option>
                            <option value="1000000">1M+</option>
                            <option value="2000000">2M+</option>
                            <option value="3000000">3M+</option>
                            <option value="5000000">5M+</option>
                        </select>
                    </div>
                </div>
                
                <!-- Trending Stock Filters -->
                <div class="filter-section trend-filters">
                    <h4>Trending Stock Filters</h4>
                    
                    <div class="filter-group">
                        <label class="filter-label" for="trend-strength">Trend Strength</label>
                        <select class="filter-select" id="trend-strength">
                            <option value="weak">Weak or Higher</option>
                            <option value="moderate" selected>Moderate or Higher</option>
                            <option value="strong">Strong Only</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label" for="trend-vwap-position">VWAP Position</label>
                        <select class="filter-select" id="trend-vwap-position">
                            <option value="uptrend_above_vwap">Uptrend + Above VWAP</option>
                            <option value="downtrend_below_vwap">Downtrend + Below VWAP</option>
                            <option value="any_vwap_position" selected>Any VWAP Position</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label" for="trend-time-window">Time Window</label>
                        <select class="filter-select" id="trend-time-window">
                            <option value="short">Short-term (3min)</option>
                            <option value="medium" selected>Medium-term (6min)</option>
                            <option value="long">Long-term (10min)</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label" for="trend-age">Trend Age</label>
                        <select class="filter-select" id="trend-age">
                            <option value="all" selected>All Ages</option>
                            <option value="fresh">Fresh (< 2min)</option>
                            <option value="recent">Recent (< 5min)</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label" for="trend-volume-confirmation">Volume Confirmation</label>
                        <select class="filter-select" id="trend-volume-confirmation">
                            <option value="volume_confirmed">Volume-Confirmed Only</option>
                            <option value="all_trends" selected>All Trends</option>
                        </select>
                    </div>
                </div>
                
                <!-- Surge Event Filters -->
                <div class="filter-section surge-filters">
                    <h4>Surge Event Filters</h4>
                    
                    <div class="filter-group">
                        <label class="filter-label" for="surge-magnitude">Surge Magnitude</label>
                        <select class="filter-select" id="surge-magnitude">
                            <option value="weak">Weak or Higher</option>
                            <option value="moderate" selected>Moderate or Higher</option>
                            <option value="strong">Strong Only</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label" for="surge-trigger-type">Trigger Type</label>
                        <select class="filter-select" id="surge-trigger-type">
                            <option value="price">Price Only</option>
                            <option value="volume">Volume Only</option>
                            <option value="price_and_volume" selected>Price + Volume</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label" for="surge-age">Surge Age</label>
                        <select class="filter-select" id="surge-age">
                            <option value="all" selected>All Ages</option>
                            <option value="fresh">Fresh (< 30sec)</option>
                            <option value="recent">Recent (< 2min)</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Price Range</label>
                        <div class="filter-checkboxes">
                            <label class="filter-checkbox-label">
                                <input type="checkbox" class="filter-checkbox" value="penny" checked>
                                <span>Penny Stocks (< $1)</span>
                            </label>
                            <label class="filter-checkbox-label">
                                <input type="checkbox" class="filter-checkbox" value="low" checked>
                                <span>Low Price ($1-$25)</span>
                            </label>
                            <label class="filter-checkbox-label">
                                <input type="checkbox" class="filter-checkbox" value="mid" checked>
                                <span>Mid Price ($25-$100)</span>
                            </label>
                            <label class="filter-checkbox-label">
                                <input type="checkbox" class="filter-checkbox" value="high" checked>
                                <span>High Price ($100+)</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button id="applyFiltersBtn" class="btn btn-primary">Apply Filters</button>
                <button id="cancelFiltersBtn" class="btn btn-secondary">Cancel</button>
                <button id="resetFiltersBtn" class="btn btn-tertiary">Reset All</button>
            </div>
        </div>
    </div>

    <!-- JavaScript Loading - Modular Order -->
    <script src="{{ url_for('static', filename='js/core/app-core.js') }}"></script>
    <script src="{{ url_for('static', filename='js/core/app-universe.js') }}"></script>
    <script src="{{ url_for('static', filename='js/core/app-filters.js') }}"></script>
    <script src="{{ url_for('static', filename='js/core/app-gauges.js') }}"></script>
    <script src="{{ url_for('static', filename='js/core/app-events.js') }}"></script>
    <script src="{{ url_for('static', filename='js/core/app-gridstack.js') }}"></script>
    <script src="{{ url_for('static', filename='js/core/app-layout-sync.js') }}"></script>
    </body>
</html>