{% extends "admin/base_admin.html" %}

{% block title %}Historical Data Management - TickStock Admin{% endblock %}

{% block extra_css %}
<style>
    /* Theme-aware styles for historical data dashboard */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: var(--color-background-secondary);
        border: 1px solid var(--color-border-light);
        border-radius: 8px;
        padding: 20px;
        transition: all 0.3s;
    }
    
    .stat-card:hover {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: var(--color-primary);
    }
    
    .stat-label {
        color: var(--color-text-secondary);
        font-size: 0.9em;
        margin-top: 5px;
    }
    
    .job-controls {
        background: var(--color-background-primary);
        border: 1px solid var(--color-border-light);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .form-row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
        align-items: end;
    }
    
    .form-group {
        flex: 1;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: var(--color-text-primary);
    }
    
    .jobs-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
    
    @media (max-width: 768px) {
        .jobs-section {
            grid-template-columns: 1fr;
        }
    }
    
    .job-card {
        background: var(--color-background-primary);
        border: 1px solid var(--color-border-light);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        transition: all 0.3s;
    }
    
    .job-card:hover {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .job-status {
        padding: 4px 8px;
        border-radius: 4px;
        color: white;
        font-size: 0.8em;
        font-weight: bold;
        display: inline-block;
    }
    
    .status-running { 
        background-color: #ffc107; 
        color: #000; 
    }
    .status-completed { 
        background-color: #28a745; 
    }
    .status-failed { 
        background-color: #dc3545; 
    }
    .status-cancelled { 
        background-color: #6c757d; 
    }
    
    .progress-bar {
        width: 100%;
        height: 20px;
        background-color: var(--color-background-secondary);
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
    }
    
    .progress-fill {
        height: 100%;
        background-color: var(--color-primary);
        transition: width 0.3s ease;
    }
    
    .log-messages {
        max-height: 200px;
        overflow-y: auto;
        background: var(--color-background-secondary);
        color: var(--color-text-primary);
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 0.9em;
        border: 1px solid var(--color-border-light);
    }
    
    /* Dark theme specific adjustments */
    .theme-dark .stat-card {
        background: #2a2a2a;
        border-color: #444;
    }
    
    .theme-dark .job-controls {
        background: #1f1f1f;
        border-color: #444;
    }
    
    .theme-dark .job-card {
        background: #2a2a2a;
        border-color: #444;
    }
    
    .theme-dark .log-messages {
        background: #1a1a1a;
        border-color: #444;
    }
    
    .theme-dark .progress-bar {
        background-color: #333;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">Historical Data Management</h2>
        
        <!-- Statistics Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalSymbols">{{ total_symbols|default(0) }}</div>
                <div class="stat-label">Total Symbols</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="dailyRecords">{{ daily_records|default(0) }}</div>
                <div class="stat-label">Daily Records</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="minuteRecords">{{ minute_records|default(0) }}</div>
                <div class="stat-label">1-Minute Records</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeJobs">0</div>
                <div class="stat-label">Active Jobs</div>
            </div>
        </div>
        
        <!-- Job Controls -->
        <div class="job-controls">
            <h3>Load Historical Data</h3>
            <form id="loadDataForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="loadType">Load Type</label>
                        <select class="form-select" id="loadType" name="load_type">
                            <option value="universe">Universe</option>
                            <option value="symbols">Specific Symbols</option>
                        </select>
                    </div>
                    <div class="form-group" id="universeGroup">
                        <label for="universe">Universe</label>
                        <select class="form-select" id="universe" name="universe">
                            <option value="top_50">Top 50</option>
                            <option value="sp500">S&P 500</option>
                            <option value="nasdaq100">NASDAQ 100</option>
                            <option value="dow30">Dow 30</option>
                            <option value="all">All Active</option>
                        </select>
                    </div>
                    <div class="form-group" id="symbolsGroup" style="display: none;">
                        <label for="symbols">Symbols (comma-separated)</label>
                        <input type="text" class="form-control" id="symbols" name="symbols" 
                               placeholder="AAPL,GOOGL,MSFT">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="timeframe">Timeframe</label>
                        <select class="form-select" id="timeframe" name="timeframe">
                            <option value="day">Daily</option>
                            <option value="minute">1-Minute</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="years">Years of Data</label>
                        <input type="number" class="form-control" id="years" name="years" 
                               value="1" min="0.1" max="10" step="0.1">
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-download me-2"></i>Start Loading
                        </button>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- Jobs Section -->
        <div class="jobs-section">
            <!-- Active Jobs -->
            <div>
                <h3>Active Jobs</h3>
                <div id="activeJobsList">
                    <div class="text-muted">No active jobs</div>
                </div>
            </div>
            
            <!-- Completed Jobs -->
            <div>
                <h3>Recent Jobs</h3>
                <div id="completedJobsList">
                    <div class="text-muted">No completed jobs</div>
                </div>
            </div>
        </div>
        
        <!-- Data Quality Section -->
        <div class="card mt-4">
            <div class="card-header">
                <h3 class="mb-0">Data Quality Tools</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <button class="btn btn-warning w-100 mb-2" onclick="cleanDuplicates()">
                            <i class="fas fa-broom me-2"></i>Clean Duplicates
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-danger w-100 mb-2" onclick="removeOldData()">
                            <i class="fas fa-trash me-2"></i>Remove Old Data
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-info w-100 mb-2" onclick="detectGaps()">
                            <i class="fas fa-search me-2"></i>Detect Data Gaps
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alert Container -->
<div id="alertContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 11"></div>
{% endblock %}

{% block extra_js %}
<script>
    // Form handling
    document.getElementById('loadType').addEventListener('change', function() {
        const universeGroup = document.getElementById('universeGroup');
        const symbolsGroup = document.getElementById('symbolsGroup');
        
        if (this.value === 'universe') {
            universeGroup.style.display = 'block';
            symbolsGroup.style.display = 'none';
        } else {
            universeGroup.style.display = 'none';
            symbolsGroup.style.display = 'block';
        }
    });
    
    // Form submission
    document.getElementById('loadDataForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        
        // Start loading job
        fetch('/admin/historical-data/load', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showAlert('Job started successfully', 'success');
                updateJobsList();
            } else {
                showAlert(result.error || 'Failed to start job', 'danger');
            }
        })
        .catch(error => {
            showAlert('Error: ' + error.message, 'danger');
        });
    });
    
    // Alert function
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.getElementById('alertContainer').appendChild(alertDiv);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }
    
    // Update jobs list
    function updateJobsList() {
        fetch('/admin/historical-data/jobs')
            .then(response => response.json())
            .then(data => {
                updateActiveJobs(data.active);
                updateCompletedJobs(data.completed);
                document.getElementById('activeJobs').textContent = data.active.length;
            });
    }
    
    function updateActiveJobs(jobs) {
        const container = document.getElementById('activeJobsList');
        if (jobs.length === 0) {
            container.innerHTML = '<div class="text-muted">No active jobs</div>';
            return;
        }
        
        container.innerHTML = jobs.map(job => `
            <div class="job-card">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="job-status status-${job.status}">${job.status}</span>
                    <button class="btn btn-sm btn-danger" onclick="cancelJob('${job.id}')">Cancel</button>
                </div>
                <div class="mt-2">
                    <strong>${job.type}</strong> - ${job.description}
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${job.progress}%"></div>
                </div>
                <div class="text-muted small">${job.progress}% complete</div>
            </div>
        `).join('');
    }
    
    function updateCompletedJobs(jobs) {
        const container = document.getElementById('completedJobsList');
        if (jobs.length === 0) {
            container.innerHTML = '<div class="text-muted">No completed jobs</div>';
            return;
        }
        
        container.innerHTML = jobs.slice(0, 5).map(job => `
            <div class="job-card">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="job-status status-${job.status}">${job.status}</span>
                    <span class="text-muted small">${job.completed_at}</span>
                </div>
                <div class="mt-2">
                    <strong>${job.type}</strong> - ${job.description}
                </div>
                ${job.error ? `<div class="text-danger small mt-1">${job.error}</div>` : ''}
            </div>
        `).join('');
    }
    
    // Data quality functions
    function cleanDuplicates() {
        if (confirm('This will remove duplicate records. Continue?')) {
            fetch('/admin/historical-data/clean-duplicates', { method: 'POST' })
                .then(response => response.json())
                .then(result => {
                    showAlert(result.message || 'Duplicates cleaned', result.success ? 'success' : 'danger');
                });
        }
    }
    
    function removeOldData() {
        const days = prompt('Remove data older than how many days?', '365');
        if (days) {
            fetch('/admin/historical-data/remove-old', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ days: parseInt(days) })
            })
            .then(response => response.json())
            .then(result => {
                showAlert(result.message || 'Old data removed', result.success ? 'success' : 'danger');
            });
        }
    }
    
    function detectGaps() {
        fetch('/admin/historical-data/detect-gaps')
            .then(response => response.json())
            .then(result => {
                if (result.gaps && result.gaps.length > 0) {
                    showAlert(`Found ${result.gaps.length} data gaps`, 'warning');
                } else {
                    showAlert('No data gaps detected', 'success');
                }
            });
    }
    
    function cancelJob(jobId) {
        if (confirm('Cancel this job?')) {
            fetch(`/admin/historical-data/jobs/${jobId}/cancel`, { method: 'POST' })
                .then(response => response.json())
                .then(result => {
                    showAlert(result.message || 'Job cancelled', result.success ? 'success' : 'danger');
                    updateJobsList();
                });
        }
    }
    
    // Update stats on load
    function updateStats() {
        fetch('/admin/historical-data/stats')
            .then(response => response.json())
            .then(data => {
                document.getElementById('totalSymbols').textContent = data.total_symbols || 0;
                document.getElementById('dailyRecords').textContent = data.daily_records || 0;
                document.getElementById('minuteRecords').textContent = data.minute_records || 0;
            });
    }
    
    // Initial load and periodic updates
    updateStats();
    updateJobsList();
    setInterval(updateJobsList, 5000); // Update every 5 seconds
    setInterval(updateStats, 30000); // Update stats every 30 seconds
</script>
{% endblock %}