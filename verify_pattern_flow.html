<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pattern Flow Verification</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .verification-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .check-item {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .status-pass { color: #28a745; font-weight: bold; }
        .status-fail { color: #dc3545; font-weight: bold; }
        .status-pending { color: #ffc107; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Pattern Flow Display Verification</h1>
        <p>This page verifies that the Pattern Flow display is correctly configured with 4 columns and minimal rows.</p>

        <div class="verification-section">
            <h3>Component Loading Checks</h3>
            <div class="check-item">
                <span>PatternFlowService:</span>
                <span id="check-service" class="status-pending">Checking...</span>
            </div>
            <div class="check-item">
                <span>TierPatternService:</span>
                <span id="check-tier" class="status-pending">Checking...</span>
            </div>
            <div class="check-item">
                <span>Bootstrap CSS:</span>
                <span id="check-bootstrap" class="status-pending">Checking...</span>
            </div>
        </div>

        <div class="verification-section">
            <h3>Layout Verification</h3>
            <div class="check-item">
                <span>4-Column Layout:</span>
                <span id="check-columns" class="status-pending">Checking...</span>
            </div>
            <div class="check-item">
                <span>Row Height (60px):</span>
                <span id="check-row-height" class="status-pending">Checking...</span>
            </div>
            <div class="check-item">
                <span>Auto-Refresh Timer:</span>
                <span id="check-refresh" class="status-pending">Checking...</span>
            </div>
        </div>

        <div class="verification-section">
            <h3>Pattern Flow Display</h3>
            <div id="pattern-flow-test"></div>
        </div>

        <div class="verification-section">
            <h3>Test Results</h3>
            <pre id="test-results"></pre>
        </div>
    </div>

    <!-- Load required scripts -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
        // Mock socket.io
        window.io = function() {
            return {
                on: function() {},
                emit: function() {},
                off: function() {},
                connected: false
            };
        };
        window.socket = io();
    </script>
    <script src="web/static/js/services/tier_pattern_service.js"></script>
    <script src="web/static/js/services/pattern_flow.js"></script>

    <script>
        const results = [];

        function checkComponent(name, condition, elementId) {
            const status = condition ? 'PASS' : 'FAIL';
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = status;
                element.className = condition ? 'status-pass' : 'status-fail';
            }
            results.push(`${name}: ${status}`);
            return condition;
        }

        async function runVerification() {
            // Check component loading
            checkComponent('PatternFlowService', typeof PatternFlowService !== 'undefined', 'check-service');
            checkComponent('TierPatternService', typeof TierPatternService !== 'undefined', 'check-tier');
            checkComponent('Bootstrap CSS', !!document.querySelector('link[href*="bootstrap"]'), 'check-bootstrap');

            // Initialize Pattern Flow
            if (typeof PatternFlowService !== 'undefined') {
                try {
                    const service = new PatternFlowService();
                    await service.initialize('#pattern-flow-test');

                    // Check layout
                    setTimeout(() => {
                        // Check for 4 columns
                        const columns = document.querySelectorAll('.pattern-column');
                        checkComponent('4-Column Layout', columns.length === 4, 'check-columns');

                        // Check column titles
                        const columnTitles = Array.from(columns).map(col => {
                            const header = col.querySelector('h5');
                            return header ? header.textContent.trim() : '';
                        });

                        const expectedTitles = ['Daily', 'Intraday', 'Combo', 'Indicators'];
                        const titlesMatch = expectedTitles.every(title =>
                            columnTitles.some(colTitle => colTitle.includes(title))
                        );

                        results.push(`Column Titles: ${titlesMatch ? 'PASS' : 'FAIL'}`);
                        results.push(`Found columns: ${columnTitles.join(', ')}`);

                        // Check row height CSS
                        const hasRowHeightCSS = !!document.querySelector('style')?.textContent.includes('height: 60px');
                        checkComponent('Row Height CSS', hasRowHeightCSS, 'check-row-height');

                        // Check refresh timer
                        const hasCountdown = !!document.querySelector('.countdown-display');
                        checkComponent('Auto-Refresh Timer', hasCountdown, 'check-refresh');

                        // Check refresh interval
                        if (service.config) {
                            results.push(`Refresh Interval: ${service.config.refreshInterval}ms (${service.config.refreshInterval / 1000}s)`);
                            results.push(`Max Patterns Per Column: ${service.config.maxPatternsPerColumn}`);
                        }

                        // Display results
                        document.getElementById('test-results').textContent = results.join('\n');

                        // Add mock data to test display
                        const mockData = {
                            tier: 'daily',
                            pattern: {
                                id: 'test_001',
                                symbol: 'AAPL',
                                type: 'Bull Flag',
                                timestamp: new Date().toISOString(),
                                confidence: 0.85
                            }
                        };
                        service.handleNewPattern(mockData);

                        // Summary
                        const allPassed = !results.some(r => r.includes('FAIL'));
                        results.push('\n' + '='.repeat(40));
                        results.push(allPassed ? 'ALL CHECKS PASSED ✅' : 'SOME CHECKS FAILED ❌');
                        document.getElementById('test-results').textContent = results.join('\n');

                    }, 1000);

                } catch (error) {
                    results.push(`Initialization Error: ${error.message}`);
                    document.getElementById('test-results').textContent = results.join('\n');
                }
            } else {
                results.push('PatternFlowService not loaded - cannot proceed with verification');
                document.getElementById('test-results').textContent = results.join('\n');
            }
        }

        // Run verification on load
        window.addEventListener('load', () => {
            setTimeout(runVerification, 1000);
        });
    </script>
</body>
</html>