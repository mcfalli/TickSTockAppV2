name: "Sprint 67 - Market Breadth Multi-Instance Enhancement PRP"
description: |
  Document and enhance Market Breadth component for widespread reuse throughout TickStockAppV2.
  Create Index Comparison page with side-by-side SPY|QQQ|dow30 breadth metrics.
  Establish patterns for reusable multi-instance components.

---

## Goal

**Feature Goal**: Enable Market Breadth component to be used on multiple pages simultaneously with different configurations, starting with an Index Comparison page showing SPY, QQQ, and dow30 side-by-side.

**Deliverable**:
1. Index Comparison page (`web/templates/dashboard/index_comparison.html`) with 3 breadth metric instances
2. Usage documentation (`docs/guides/components/market-breadth-usage.md`)
3. Component API documentation (`docs/api/components.md`)
4. Sidebar navigation integration

**Success Definition**:
- User can view 3 index breadth metrics side-by-side on Index Comparison page
- Each instance shows accurate, independent data
- Page loads in <500ms (3 × <100ms API calls + rendering)
- Documentation enables developers to add breadth metrics to any page
- Zero regression on existing Market Breadth page

## User Persona

**Target User**: Traders and market analysts comparing breadth across major indices

**Use Case**: Compare market health signals across S&P 500, NASDAQ 100, and Dow 30 simultaneously to identify divergences (e.g., S&P strong but NASDAQ weak = defensive rotation)

**User Journey**:
1. User clicks "Index Comparison" in sidebar
2. Page loads with 3 columns: SPY | QQQ | dow30
3. User sees 12 breadth metrics for each index simultaneously
4. User identifies divergences (e.g., SPY 70% up-day but QQQ only 45% up-day)
5. User draws conclusions about sector rotation or market leadership changes

**Pain Points Addressed**:
- Eliminates manual switching between universe selector
- Enables quick visual comparison of breadth trends
- Highlights divergences that signal market regime changes

## Why

- **Business Value**: Breadth divergence detection is a professional trading tool - enables traders to spot sector rotation and market regime changes in real-time
- **Integration**: Leverages Sprint 66 reusable template design (instance_id parameter already supports multi-instance)
- **Problems Solved**: Current Market Breadth page requires manual universe selection - traders can't compare indices simultaneously without toggling selector
- **User Impact**: Saves 2-3 minutes per analysis session (3-5 sessions/day) = 30-45 min/week for active traders

## What

Create Index Comparison dashboard page with side-by-side breadth metrics for SPY, QQQ, and dow30, plus comprehensive documentation for developers to reuse breadth component on other pages.

### Success Criteria

- [ ] Index Comparison page loads with 3 breadth metric instances visible
- [ ] Each instance shows accurate, independent data (verified against database)
- [ ] Page performance: Total load time <500ms (3 parallel API calls)
- [ ] Responsive design: Desktop (3-column grid), Tablet/Mobile (stacked vertically)
- [ ] Navigation: "Index Comparison" sidebar item with fas fa-balance-scale icon
- [ ] Documentation: Usage guide with 3+ examples (single instance, multi-instance, embedded)
- [ ] Documentation: Component API reference with all parameters documented
- [ ] Zero regression: Existing Market Breadth page still works identically
- [ ] Clean commit: No "Generated by Claude" comments

## All Needed Context

### Context Completeness Check

✅ **Sprint 66 Implementation Analyzed**: Complete research on breadth_metrics_service.py, market_breadth.html template, breadth-metrics-renderer.js, CSS patterns, navigation integration

✅ **Sprint 64 Comparison Completed**: Threshold bars multi-instance patterns documented, reusable patterns extracted

✅ **Template Reusability Validated**: Instance_id parameter enables multiple instances, show_controls parameter hides selectors for fixed displays

✅ **Performance Targets Clear**: 3 × <100ms API calls = ~300ms total (parallel fetch), <200ms rendering

✅ **External Research**: Bootstrap grid, CSS Flexbox multi-column layouts, responsive breakpoints

### TickStock Architecture Context

```yaml
tickstock_architecture:
  component: TickStockAppV2
  role: Consumer (read-only)

  database_access:
    mode: read-only
    tables:
      - ohlcv_daily (252 days × 500+ symbols per universe)
      - definition_groups (ETF/universe definitions)
      - group_memberships (symbol-to-universe mappings)
    queries: "Single OHLCV query per universe (3 total), RelationshipCache for symbol loading"

  websocket_integration:
    broadcast_to: null  # Feature does not use WebSocket (REST API only)

  api_endpoints:
    existing: "GET /api/breadth-metrics?universe={SPY|QQQ|dow30|nasdaq100}"
    performance: "<100ms per universe (Sprint 66 validated)"

  performance_targets:
    - metric: "Database query (per universe)"
      target: "<30ms (252 days × 500 symbols)"

    - metric: "Service calculation (12 metrics)"
      target: "<50ms per universe"

    - metric: "API response (total)"
      target: "<100ms per universe"

    - metric: "Page load (3 universes parallel)"
      target: "<500ms (3 × ~150ms + rendering)"

    - metric: "DOM rendering (3 × 12 metric rows)"
      target: "<200ms total"
```

### Documentation & References

```yaml
# CRITICAL - Read these files for context
sprint_66_implementation:
  - file: src/core/services/breadth_metrics_service.py
    why: "Understand 12 metric calculations, vectorized pandas patterns"
    pattern: "Load symbols → Query OHLCV → Calculate → Aggregate → Return dict"
    gotcha: "Uses 'date' column (NOT 'timestamp'), must cast cutoff_datetime.date()"
    lines: 415

  - file: src/core/models/breadth_metrics_models.py
    why: "Pydantic v2 validation models for API"
    pattern: "BreadthMetricsRequest, MetricData, BreadthMetricsResponse"
    lines: 160

  - file: src/api/rest/breadth_metrics.py
    why: "Flask Blueprint, endpoint registration pattern"
    pattern: "ValidationError → 400, ValueError → 400, RuntimeError → 500"
    lines: 123

  - file: web/templates/dashboard/market_breadth.html
    why: "Reusable template with instance_id, universe, title, show_controls parameters"
    pattern: "Jinja2 {% set var %} then {% include %} pattern"
    gotcha: "MUST use unique instance_id per include to avoid DOM collisions"
    critical_lines:
      - "Line 19: data-breadth-instance attribute for scoping"
      - "Lines 54-58: IIFE closure captures Jinja2 variables"
      - "Lines 62-69: window['initializeBreadthMetrics_' + instanceId] pattern"
    lines: 120

  - file: web/static/js/components/breadth-metrics-renderer.js
    why: "JavaScript component for rendering 12 metric rows"
    pattern: "Class with constructor, async render(), createMetricsHTML(), setupAutoRefresh()"
    gotcha: "Auto-refresh timer must be unique per instance (no shared timer)"
    lines: 257

  - file: web/static/css/components/breadth-metrics.css
    why: "Flexbox horizontal bar chart styling, responsive design"
    pattern: "3-part row: metric-label (120px) | metric-bar-container (flex:1) | metric-counts (120px)"
    gotcha: "@768px breakpoint for mobile, reduces heights and stacks labels"
    lines: 225

  - file: web/static/js/components/sidebar-navigation-controller.js
    why: "Navigation registration and content loading patterns"
    pattern: "Register section → Load hidden content → Initialize with setTimeout(200ms)"
    critical_lines:
      - "Lines 60-66: Section configuration (title, icon, component, description)"
      - "Lines 471-495: Special content loader for market-breadth (MUST replicate for index-comparison)"
    gotcha: "Need special handling for loading hidden div content (generic component pattern doesn't work)"

sprint_64_comparison:
  - file: web/templates/dashboard/market_overview.html
    why: "Example of multiple threshold bars on same page (14 instances)"
    pattern: "Hardcoded configuration array with renderAllBars() loop"
    diff: "Sprint 64 hardcodes configs, Sprint 66 uses reusable template (better pattern)"

  - file: web/static/js/components/threshold-bar-renderer.js
    why: "Similar renderer architecture to breadth-metrics-renderer"
    pattern: "Class-based, async render(), CSRF token extraction, error handling"

existing_dashboard_layouts:
  - file: web/templates/dashboard/index.html
    why: "Main dashboard template structure, includes CSS/JS links"
    pattern: "<!-- CSS --> → <!-- JS --> → <!-- Content sections as hidden divs -->"
    lines: 400+

  - file: web/static/css/base/layout.css
    why: "Grid and flexbox layout utilities"
    pattern: "Responsive breakpoints, container classes"

# External Documentation
external_references:
  - url: "https://getbootstrap.com/docs/5.3/layout/grid/#row-columns"
    why: "3-column grid pattern for desktop layout"
    critical: "Use CSS Grid (NOT Bootstrap classes) - TickStock doesn't use Bootstrap"

  - url: "https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Grid_Layout/Basic_Concepts_of_Grid_Layout"
    why: "CSS Grid multi-column responsive layout"
    critical: "grid-template-columns: repeat(3, 1fr) for equal-width columns"

  - url: "https://developer.mozilla.org/en-US/docs/Web/CSS/@media"
    why: "Responsive breakpoints for mobile/tablet"
    critical: "@media (max-width: 1200px) { grid-template-columns: 1fr; } for stacking"
```

### Current Codebase Tree (Sprint 66 Files)

```bash
TickStockAppV2/
├── src/
│   ├── core/
│   │   ├── models/
│   │   │   └── breadth_metrics_models.py     # Pydantic models (already exists)
│   │   └── services/
│   │       ├── breadth_metrics_service.py    # Service layer (already exists)
│   │       └── relationship_cache.py         # Symbol loading (already exists)
│   └── api/
│       └── rest/
│           └── breadth_metrics.py            # API endpoint (already exists)
├── web/
│   ├── static/
│   │   ├── css/
│   │   │   └── components/
│   │   │       └── breadth-metrics.css       # Styles (already exists)
│   │   └── js/
│   │       └── components/
│   │           ├── breadth-metrics-renderer.js    # Renderer (already exists)
│   │           └── sidebar-navigation-controller.js  # Navigation (modify)
│   └── templates/
│       └── dashboard/
│           ├── index.html                    # Main dashboard (modify)
│           ├── market_breadth.html           # Reusable template (already exists)
│           └── market_overview.html          # Sprint 64 example
└── docs/
    ├── api/
    │   └── endpoints.md                      # API docs (update)
    └── guides/
        └── features.md                        # Feature docs (update)
```

### Desired Codebase Tree with New Files

```bash
TickStockAppV2/
├── web/
│   ├── static/
│   │   └── css/
│   │       └── components/
│   │           └── index-comparison.css      # NEW: Layout styles for 3-column grid
│   └── templates/
│       └── dashboard/
│           └── index_comparison.html         # NEW: Index Comparison page template
└── docs/
    ├── api/
    │   └── components.md                     # NEW: Component API documentation
    ├── guides/
    │   └── components/
    │       └── market-breadth-usage.md       # NEW: Usage guide with examples
    └── planning/
        └── sprints/
            └── sprint67/
                ├── market-breadth-multi-instance.md       # THIS FILE
                └── SPRINT67_COMPLETE.md                   # Created post-implementation

# Modified Files (3):
- web/static/js/components/sidebar-navigation-controller.js  (add index-comparison section + loader)
- web/templates/dashboard/index.html                         (add hidden content div + CSS link)
- CLAUDE.md                                                  (add Sprint 67 status)
```

### Known Gotchas & Library Quirks

```python
# CRITICAL: Sprint 66 Multi-Instance Pattern
# market_breadth.html template REQUIRES unique instance_id per include

# WRONG - Instance ID collision (both use 'default')
{% set instance_id='default' %}{% set universe='SPY' %}
{% include 'dashboard/market_breadth.html' %}
{% set instance_id='default' %}{% set universe='QQQ' %}  # COLLISION!
{% include 'dashboard/market_breadth.html' %}

# CORRECT - Unique instance IDs
{% set instance_id='spy' %}{% set universe='SPY' %}
{% include 'dashboard/market_breadth.html' %}
{% set instance_id='qqq' %}{% set universe='QQQ' %}
{% include 'dashboard/market_breadth.html' %}
{% set instance_id='dow' %}{% set universe='dow30' %}
{% include 'dashboard/market_breadth.html' %}

# CRITICAL: JavaScript Initialization Function Naming
# Each instance creates: window['initializeBreadthMetrics_' + instanceId]
# With instance_id='spy', creates: window.initializeBreadthMetrics_spy()
# With instance_id='qqq', creates: window.initializeBreadthMetrics_qqq()
# With instance_id='dow', creates: window.initializeBreadthMetrics_dow()

# CRITICAL: Show Controls Parameter
# For Index Comparison page, set show_controls=False to hide universe selector
# (User shouldn't change universes - each column is fixed to specific index)
{% set show_controls=False %}

# CRITICAL: Jinja2 Variable Scope in Template
# Variables MUST be captured in IIFE closure immediately (lines 54-58)
# Without closure, all instances share same variable values (last one wins)

(function() {
    const instanceId = '{{ instance_id }}';     # Captured immediately
    const universe = '{{ universe }}';
    const title = '{{ title }}';
    # ... use captured variables, NOT template variables
})();

# CRITICAL: Sidebar Navigation Special Handling Required
# Generic navigation pattern (lines 511-517) does NOT work for multi-instance pages
# MUST use special content loader pattern (lines 471-495) like market-breadth

# Example from sidebar-navigation-controller.js lines 471-495:
else if (sectionKey === 'market-breadth') {
    const marketBreadthContent = document.getElementById('market-breadth-content');
    if (marketBreadthContent) {
        contentArea.innerHTML = marketBreadthContent.innerHTML;

        setTimeout(() => {
            if (typeof window.initializeBreadthMetrics_default === 'function') {
                window.initializeBreadthMetrics_default();
            }
        }, 200);
    }
}

# REPLICATE this pattern for 'index-comparison' with 3 initialization calls:
else if (sectionKey === 'index-comparison') {
    const indexComparisonContent = document.getElementById('index-comparison-content');
    if (indexComparisonContent) {
        contentArea.innerHTML = indexComparisonContent.innerHTML;

        setTimeout(() => {
            # Call all 3 instance initialization functions
            if (typeof window.initializeBreadthMetrics_spy === 'function') {
                window.initializeBreadthMetrics_spy();
            }
            if (typeof window.initializeBreadthMetrics_qqq === 'function') {
                window.initializeBreadthMetrics_qqq();
            }
            if (typeof window.initializeBreadthMetrics_dow === 'function') {
                window.initializeBreadthMetrics_dow();
            }
        }, 200);
    }
}

# CRITICAL: Performance - Parallel API Fetches
# Each instance makes separate API call
# Use Promise.all() for parallel execution (NOT sequential)

# WRONG - Sequential (300ms+ total):
await fetchSPY();
await fetchQQQ();
await fetchDow30();

# CORRECT - Parallel (~100ms total):
await Promise.all([fetchSPY(), fetchQQQ(), fetchDow30()]);
# Auto-handled by renderer.render() - already async

# CRITICAL: CSS Grid Responsive Breakpoint
# Desktop (>1200px): 3-column grid
# Tablet/Mobile (≤1200px): Single column (stacked)

.index-comparison-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);  # 3 equal columns
    gap: 20px;
}

@media (max-width: 1200px) {
    .index-comparison-grid {
        grid-template-columns: 1fr;  # Stack vertically
    }
}

# CRITICAL: DOM Element Visibility
# Content div MUST be hidden initially (display: none)
# Sidebar navigation shows it by copying innerHTML to content area

<div id="index-comparison-content" style="display: none;">
    <!-- 3 breadth metric instances here -->
</div>

# CRITICAL: Auto-Refresh Coordination
# Each instance has independent 60s refresh timer
# 3 instances = 3 timers, may fire at same time (acceptable)
# API can handle 3 concurrent requests (<300ms total)

# CRITICAL: Zero Regression Testing
# Existing Market Breadth page must still work identically
# Test: Navigate to Market Breadth → verify 12 metrics render → change universe → verify updates
```

## Implementation Blueprint

### Data Models and Structure

No new data models required - reuse Sprint 66 existing models:

```python
# Existing (NO CHANGES):
# src/core/models/breadth_metrics_models.py
class BreadthMetricsRequest(BaseModel):
    universe: UniverseKey = Field(default="SPY", ...)

class MetricData(BaseModel):
    up: int
    down: int
    unchanged: int
    pct_up: float

class BreadthMetricsResponse(BaseModel):
    metrics: dict[str, MetricData]
    metadata: BreadthMetricsMetadata

# Existing (NO CHANGES):
# src/core/services/breadth_metrics_service.py
# src/api/rest/breadth_metrics.py
# All backend infrastructure already complete from Sprint 66
```

### Implementation Tasks (ordered by dependencies)

```yaml
# Phase 1: Create Index Comparison Page Template and Layout

Task 1: CREATE web/templates/dashboard/index_comparison.html
  - IMPLEMENT: New Jinja2 template for Index Comparison page
  - STRUCTURE:
      * Include CSS: breadth-metrics.css, index-comparison.css
      * Include JS: breadth-metrics-renderer.js
      * Create 3-column grid div with class "index-comparison-grid"
      * Include market_breadth.html template 3 times with unique instance_ids
  - NAMING: File matches sidebar section key 'index-comparison'
  - PLACEMENT: web/templates/dashboard/ alongside market_overview.html
  - PATTERN: Follow market_overview.html structure but with reusable template includes
  - CRITICAL: Each include MUST have unique instance_id (spy, qqq, dow)
  - CRITICAL: Set show_controls=False for all 3 instances (fixed universes)
  - TEMPLATE CODE:
      {% extends 'base.html' %}
      {% block title %}Index Comparison - TickStock{% endblock %}

      {% block extra_css %}
      <link rel="stylesheet" href="{{ url_for('static', filename='css/components/breadth-metrics.css') }}">
      <link rel="stylesheet" href="{{ url_for('static', filename='css/components/index-comparison.css') }}">
      {% endblock %}

      {% block extra_js %}
      <script src="{{ url_for('static', filename='js/components/breadth-metrics-renderer.js') }}"></script>
      {% endblock %}

      {% block content %}
      <div class="container-fluid p-4">
          <h1><i class="fas fa-balance-scale me-2"></i>Index Comparison</h1>
          <p class="text-muted">Side-by-side breadth metrics for major indices</p>

          <div class="index-comparison-grid">
              <!-- S&P 500 Column -->
              <div class="index-column">
                  {% set instance_id='spy' %}
                  {% set universe='SPY' %}
                  {% set title='S&P 500 Breadth' %}
                  {% set show_controls=False %}
                  {% include 'dashboard/market_breadth.html' %}
              </div>

              <!-- NASDAQ 100 Column -->
              <div class="index-column">
                  {% set instance_id='qqq' %}
                  {% set universe='QQQ' %}
                  {% set title='NASDAQ 100 Breadth' %}
                  {% set show_controls=False %}
                  {% include 'dashboard/market_breadth.html' %}
              </div>

              <!-- Dow 30 Column -->
              <div class="index-column">
                  {% set instance_id='dow' %}
                  {% set universe='dow30' %}
                  {% set title='Dow 30 Breadth' %}
                  {% set show_controls=False %}
                  {% include 'dashboard/market_breadth.html' %}
              </div>
          </div>
      </div>
      {% endblock %}
  - VALIDATION: Template renders without Jinja2 syntax errors

Task 2: CREATE web/static/css/components/index-comparison.css
  - IMPLEMENT: CSS Grid layout for 3-column responsive design
  - PATTERN: CSS Grid with equal-width columns, responsive breakpoint at 1200px
  - PLACEMENT: web/static/css/components/ alongside breadth-metrics.css
  - CSS CODE:
      /* Index Comparison 3-Column Grid Layout */
      .index-comparison-grid {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 20px;
          margin: 20px 0;
      }

      .index-column {
          min-width: 0; /* Prevent grid blowout */
      }

      /* Responsive: Stack vertically on tablets/mobile */
      @media (max-width: 1200px) {
          .index-comparison-grid {
              grid-template-columns: 1fr;
          }
      }

      /* Compact view for multi-instance pages */
      .index-comparison-grid .breadth-metrics-section {
          margin-bottom: 0; /* Reduce vertical spacing */
      }

      .index-comparison-grid .section-header h2 {
          font-size: 1.25rem; /* Slightly smaller titles */
      }

      /* Adjust metric row height for compact view */
      .index-comparison-grid .metric-row {
          height: 35px; /* Reduced from 40px */
          margin-bottom: 8px; /* Reduced from 10px */
      }
  - VALIDATION: CSS loads without errors, grid displays 3 columns on desktop

# Phase 2: Navigation Integration

Task 3: MODIFY web/static/js/components/sidebar-navigation-controller.js (part 1: register section)
  - INTEGRATE: Add 'index-comparison' section to sections configuration
  - LOCATION: Lines 60-70 (after 'market-breadth', before 'stock-groups')
  - NAMING: Section key 'index-comparison', title 'Index Comparison'
  - ICON: 'fas fa-balance-scale' (scales representing comparison)
  - CODE TO ADD:
      'index-comparison': {
          title: 'Index Comparison',
          icon: 'fas fa-balance-scale',
          hasFilters: false,
          component: 'initializeIndexComparison',
          description: 'Sprint 67: Side-by-side breadth metrics for SPY, QQQ, dow30'
      },
  - VALIDATION: Section appears in sidebar navigation menu

Task 4: MODIFY web/static/js/components/sidebar-navigation-controller.js (part 2: add content loader)
  - INTEGRATE: Add special content loader for 'index-comparison' section
  - LOCATION: Lines 496-530 (after 'market-breadth' loader, before 'stock-groups' loader)
  - PATTERN: Copy market-breadth loader structure (lines 471-495), modify for 3 instances
  - CRITICAL: Call all 3 initialization functions (spy, qqq, dow)
  - CODE TO ADD:
      } else if (sectionKey === 'index-comparison') {
          // Load Index Comparison content from hidden div
          const indexComparisonContent = document.getElementById('index-comparison-content');
          if (indexComparisonContent) {
              contentArea.innerHTML = `
                  <div class="container-fluid p-4">
                      ${indexComparisonContent.innerHTML}
                  </div>
              `;

              // Initialize all 3 instances after content loaded
              setTimeout(() => {
                  if (typeof window.initializeBreadthMetrics_spy === 'function') {
                      window.initializeBreadthMetrics_spy();
                  }
                  if (typeof window.initializeBreadthMetrics_qqq === 'function') {
                      window.initializeBreadthMetrics_qqq();
                  }
                  if (typeof window.initializeBreadthMetrics_dow === 'function') {
                      window.initializeBreadthMetrics_dow();
                  }
              }, 200);
          } else {
              contentArea.innerHTML = `
                  <div class="container-fluid p-4">
                      <h2><i class="${section.icon} me-2"></i>${section.title}</h2>
                      <p class="text-muted">${section.description}</p>
                      <p>Index Comparison content not found.</p>
                  </div>
              `;
          }
  - VALIDATION: Clicking "Index Comparison" in sidebar loads content and initializes 3 instances

Task 5: MODIFY web/templates/dashboard/index.html
  - INTEGRATE: Add hidden content div for index-comparison page
  - LOCATION: After market-breadth-content div (line 141), before closing main content div
  - PATTERN: Copy market-breadth-content div structure, replace with index_comparison.html include
  - CRITICAL: Style must be display:none (hidden until sidebar navigation loads it)
  - CODE TO ADD (after line 141):
      <!-- Sprint 67: Index Comparison Content (Hidden until loaded by sidebar navigation) -->
      <div id="index-comparison-content" style="display: none;">
          <h1><i class="fas fa-balance-scale me-2"></i>Index Comparison</h1>
          <p class="text-muted">Side-by-side breadth metrics for major indices</p>

          <div class="index-comparison-grid">
              <!-- S&P 500 Column -->
              <div class="index-column">
                  {% set instance_id='spy' %}
                  {% set universe='SPY' %}
                  {% set title='S&P 500 Breadth' %}
                  {% set show_controls=False %}
                  {% include 'dashboard/market_breadth.html' %}
              </div>

              <!-- NASDAQ 100 Column -->
              <div class="index-column">
                  {% set instance_id='qqq' %}
                  {% set universe='QQQ' %}
                  {% set title='NASDAQ 100 Breadth' %}
                  {% set show_controls=False %}
                  {% include 'dashboard/market_breadth.html' %}
              </div>

              <!-- Dow 30 Column -->
              <div class="index-column">
                  {% set instance_id='dow' %}
                  {% set universe='dow30' %}
                  {% set title='Dow 30 Breadth' %}
                  {% set show_controls=False %}
                  {% include 'dashboard/market_breadth.html' %}
              </div>
          </div>
      </div>
  - ALSO ADD: CSS link for index-comparison.css in head section (after breadth-metrics.css)
      <link rel="stylesheet" href="{{ url_for('static', filename='css/components/index-comparison.css') }}">
  - VALIDATION: Hidden div present, CSS loaded, Jinja2 template includes render correctly

# Phase 3: Documentation

Task 6: CREATE docs/guides/components/market-breadth-usage.md
  - IMPLEMENT: Comprehensive usage guide with 5+ examples
  - STRUCTURE:
      * Introduction (what is the component, when to use it)
      * Parameters reference (instance_id, universe, title, show_controls)
      * Usage examples (single instance, multi-instance, embedded, custom universe)
      * Performance considerations (API calls, auto-refresh, caching)
      * Troubleshooting (common issues, debugging tips)
  - PLACEMENT: docs/guides/components/ (create components/ subdirectory if needed)
  - PATTERN: Follow docs/guides/testing.md structure (clear headers, code examples, notes)
  - CONTENT STRUCTURE:
      # Market Breadth Component - Usage Guide

      ## Overview
      [What the component does, when to use it]

      ## Parameters
      [instance_id, universe, title, show_controls with defaults and types]

      ## Single Instance Usage
      [Code example with show_controls=True]

      ## Multiple Instances (Side-by-Side)
      [Code example with 3 instances, show_controls=False]

      ## Embedded in Other Pages
      [Example in stock group page, sector rotation page]

      ## Custom Universe
      [Example with theme universe like 'crypto_miners']

      ## Performance Considerations
      [API call timing, auto-refresh coordination, parallel fetches]

      ## Troubleshooting
      [Instance ID collisions, missing initialization functions, API errors]
  - VALIDATION: Markdown renders correctly, all code examples are valid Jinja2 syntax

Task 7: CREATE docs/api/components.md
  - IMPLEMENT: Component API reference documentation
  - STRUCTURE:
      * Component overview (breadth metrics component)
      * JavaScript API (BreadthMetricsRenderer class methods)
      * Template API (Jinja2 parameters)
      * REST API endpoint reference (link to endpoints.md)
      * CSS classes (customization points)
  - PLACEMENT: docs/api/ alongside endpoints.md
  - PATTERN: Follow docs/api/endpoints.md structure (clear headers, parameter tables, examples)
  - CONTENT STRUCTURE:
      # Market Breadth Component API

      ## JavaScript API
      ### BreadthMetricsRenderer Class
      [Constructor, render(), fetchData(), createMetricsHTML() methods]

      ## Template API
      ### market_breadth.html Parameters
      [Table: parameter | type | required | default | description]

      ## REST API
      ### GET /api/breadth-metrics
      [Link to docs/api/endpoints.md with full spec]

      ## CSS Classes
      ### Customization Points
      [Table: class | purpose | customizable properties]

      ## Examples
      [Usage examples from usage guide]
  - VALIDATION: Markdown renders correctly, links to endpoints.md work

Task 8: UPDATE docs/api/endpoints.md
  - INTEGRATE: Add /api/breadth-metrics endpoint documentation (if not already present)
  - LOCATION: API Endpoints section, alphabetically after /api/breadth-metrics
  - PATTERN: Follow existing endpoint documentation format
  - CONTENT: Document query parameters, response structure, error codes, examples
  - VALIDATION: Endpoint documentation complete and accurate

Task 9: UPDATE CLAUDE.md
  - INTEGRATE: Add Sprint 67 completion entry
  - LOCATION: Current Implementation Status section, after Sprint 66 entry
  - PATTERN: Follow Sprint 66 entry structure (3-5 bullet points, key deliverables)
  - CONTENT:
      ### Sprint 67 - COMPLETE ✅ (February 8, 2026)
      **Market Breadth Multi-Instance Enhancement & Reusability**
      - ✅ Index Comparison page with side-by-side SPY|QQQ|dow30 breadth metrics
      - ✅ 3-column responsive grid layout (desktop) / stacked (mobile)
      - ✅ Sidebar navigation integration with fas fa-balance-scale icon
      - ✅ Component usage documentation with 5+ examples
      - ✅ Component API reference documentation
      - ✅ Zero regression on existing Market Breadth page
      - ✅ Performance: <500ms page load (3 parallel API calls)
      - See: `docs/planning/sprints/sprint67/SPRINT67_COMPLETE.md`
  - VALIDATION: Entry added, sprint number incremented correctly

# Phase 4: Testing & Validation

Task 10: Manual Testing - Index Comparison Page
  - TEST: Navigate to Index Comparison page via sidebar
  - VERIFY: 3 breadth metric instances visible (SPY, QQQ, dow30)
  - VERIFY: Each instance shows 12 metric rows with accurate data
  - VERIFY: No universe selectors visible (show_controls=False working)
  - VERIFY: Each instance has independent data (not shared)
  - VERIFY: Page loads in <500ms (check browser DevTools Network tab)
  - VERIFY: Responsive design works (test at 1920px, 1200px, 768px widths)
  - VERIFY: Auto-refresh works for all 3 instances (wait 60s, verify updates)
  - VALIDATION: All manual tests pass

Task 11: Regression Testing - Existing Market Breadth Page
  - TEST: Navigate to Market Breadth page via sidebar
  - VERIFY: Single instance renders with universe selector visible
  - VERIFY: Changing universe selector updates metrics correctly
  - VERIFY: Refresh button works
  - VERIFY: Auto-refresh still works (60s interval)
  - VERIFY: All 12 metrics render correctly
  - VERIFY: Performance unchanged (<100ms API, <50ms rendering)
  - VALIDATION: Zero regression, existing page works identically

Task 12: Documentation Review
  - REVIEW: market-breadth-usage.md has 5+ clear examples
  - REVIEW: components.md documents all parameters and methods
  - REVIEW: Code examples in docs are valid and tested
  - REVIEW: Troubleshooting section addresses common issues
  - REVIEW: CLAUDE.md Sprint 67 entry accurate and complete
  - VALIDATION: All documentation reviewed and accurate

Task 13: Code Quality Validation
  - RUN: ruff check web/ --fix
  - RUN: ruff format web/
  - VERIFY: No linting errors in new/modified files
  - VERIFY: No "Generated by Claude" comments in code
  - VERIFY: File placement matches desired codebase tree
  - VERIFY: Naming conventions followed (kebab-case files, PascalCase classes)
  - VALIDATION: Code quality checks pass
```

### Implementation Patterns & Key Details

```python
# Pattern 1: Reusable Template with Multiple Instances
# File: web/templates/dashboard/index.html (add hidden content div)

<div id="index-comparison-content" style="display: none;">
    <div class="index-comparison-grid">
        <!-- Instance 1: SPY -->
        <div class="index-column">
            {% set instance_id='spy' %}
            {% set universe='SPY' %}
            {% set title='S&P 500 Breadth' %}
            {% set show_controls=False %}
            {% include 'dashboard/market_breadth.html' %}
        </div>

        <!-- Instance 2: QQQ -->
        <div class="index-column">
            {% set instance_id='qqq' %}
            {% set universe='QQQ' %}
            {% set title='NASDAQ 100 Breadth' %}
            {% set show_controls=False %}
            {% include 'dashboard/market_breadth.html' %}
        </div>

        <!-- Instance 3: dow30 -->
        <div class="index-column">
            {% set instance_id='dow' %}
            {% set universe='dow30' %}
            {% set title='Dow 30 Breadth' %}
            {% set show_controls=False %}
            {% include 'dashboard/market_breadth.html' %}
        </div>
    </div>
</div>

# CRITICAL POINTS:
# 1. Each instance MUST have unique instance_id (spy, qqq, dow)
# 2. Set show_controls=False to hide universe selectors (fixed columns)
# 3. Outer div MUST be style="display:none" (hidden until sidebar loads it)
# 4. Grid wrapper with class "index-comparison-grid" for CSS targeting


# Pattern 2: CSS Grid Responsive Layout
# File: web/static/css/components/index-comparison.css

.index-comparison-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);  /* 3 equal-width columns */
    gap: 20px;                               /* Space between columns */
    margin: 20px 0;
}

.index-column {
    min-width: 0;  /* CRITICAL: Prevents grid blowout with long text */
}

/* Responsive: Stack vertically on tablets/mobile */
@media (max-width: 1200px) {
    .index-comparison-grid {
        grid-template-columns: 1fr;  /* Single column (stacked) */
    }
}

# PATTERN: Use CSS Grid (NOT Flexbox) for equal-width columns
# GOTCHA: min-width: 0 on columns prevents horizontal overflow
# PERFORMANCE: Pure CSS, no JavaScript layout calculations


# Pattern 3: Sidebar Navigation Special Content Loader
# File: web/static/js/components/sidebar-navigation-controller.js

} else if (sectionKey === 'index-comparison') {
    // Load Index Comparison content from hidden div
    const indexComparisonContent = document.getElementById('index-comparison-content');
    if (indexComparisonContent) {
        contentArea.innerHTML = `
            <div class="container-fluid p-4">
                ${indexComparisonContent.innerHTML}
            </div>
        `;

        // Initialize all 3 instances after content loaded (200ms delay)
        setTimeout(() => {
            // Call each instance's initialization function
            if (typeof window.initializeBreadthMetrics_spy === 'function') {
                window.initializeBreadthMetrics_spy();
            }
            if (typeof window.initializeBreadthMetrics_qqq === 'function') {
                window.initializeBreadthMetrics_qqq();
            }
            if (typeof window.initializeBreadthMetrics_dow === 'function') {
                window.initializeBreadthMetrics_dow();
            }
        }, 200);
    } else {
        // Fallback: Show error if content div not found
        contentArea.innerHTML = `
            <div class="container-fluid p-4">
                <h2><i class="${section.icon} me-2"></i>${section.title}</h2>
                <p class="text-muted">${section.description}</p>
                <p>Index Comparison content not found.</p>
            </div>
        `;
    }
}

# CRITICAL POINTS:
# 1. Load hidden content div by ID (index-comparison-content)
# 2. Copy innerHTML to contentArea (NOT direct DOM manipulation)
# 3. setTimeout 200ms delay before initialization (DOM needs time to settle)
# 4. Call all 3 initialization functions (one per instance)
# 5. Check typeof === 'function' before calling (defensive programming)


# Pattern 4: JavaScript Initialization Functions (Auto-Created by Template)
# File: web/templates/dashboard/market_breadth.html (NO CHANGES)
# Pattern already exists from Sprint 66 - just reference it

# When template renders with instance_id='spy', creates:
window.initializeBreadthMetrics_spy = function() {
    const renderer = new BreadthMetricsRenderer();
    renderer.render('breadth-metrics-container-spy', {
        universe: 'SPY',
        title: 'S&P 500 Breadth',
        showControls: false
    });
};

# When template renders with instance_id='qqq', creates:
window.initializeBreadthMetrics_qqq = function() { ... };

# When template renders with instance_id='dow', creates:
window.initializeBreadthMetrics_dow = function() { ... };

# GOTCHA: Function names MUST match instance_id exactly
# GOTCHA: All 3 functions exist after template renders, callable from navigation loader


# Pattern 5: Performance Optimization - Parallel API Fetches
# File: web/static/js/components/breadth-metrics-renderer.js (NO CHANGES)
# Already implemented in Sprint 66 - renderer.render() is async

# When 3 instances initialize simultaneously:
window.initializeBreadthMetrics_spy();    # async fetch('/api/breadth-metrics?universe=SPY')
window.initializeBreadthMetrics_qqq();    # async fetch('/api/breadth-metrics?universe=QQQ')
window.initializeBreadthMetrics_dow();    # async fetch('/api/breadth-metrics?universe=dow30')

# JavaScript event loop handles concurrency automatically
# Result: 3 parallel fetches, ~100ms total (NOT 300ms sequential)

# PERFORMANCE: No changes needed, already optimal
# GOTCHA: Browser limits concurrent requests (usually 6 per domain)
# IMPACT: 3 requests well below limit, no queueing
```

### Integration Points

```yaml
# No new integration points - reusing Sprint 66 infrastructure

EXISTING_BACKEND:
  service: src/core/services/breadth_metrics_service.py
  models: src/core/models/breadth_metrics_models.py
  api: src/api/rest/breadth_metrics.py
  endpoint: "GET /api/breadth-metrics?universe={SPY|QQQ|dow30|nasdaq100}"
  status: "Already complete from Sprint 66, no modifications needed"

EXISTING_FRONTEND:
  template: web/templates/dashboard/market_breadth.html
  renderer: web/static/js/components/breadth-metrics-renderer.js
  styles: web/static/css/components/breadth-metrics.css
  status: "Already complete from Sprint 66, no modifications needed"

NEW_FRONTEND:
  layout_css: web/static/css/components/index-comparison.css
  navigation: web/static/js/components/sidebar-navigation-controller.js (modifications)
  dashboard: web/templates/dashboard/index.html (add hidden content div)
  status: "New files + modifications to existing"

NEW_DOCUMENTATION:
  usage_guide: docs/guides/components/market-breadth-usage.md
  api_reference: docs/api/components.md
  endpoint_docs: docs/api/endpoints.md (update)
  status_tracking: CLAUDE.md (Sprint 67 entry)
```

## Validation Loop

### Level 1: Syntax & Style (Immediate Feedback)

```bash
# Run after each file creation

# Validate CSS syntax
# (No linter available - manual review for typos)

# Validate JavaScript modifications
ruff check web/static/js/components/sidebar-navigation-controller.js --fix
ruff format web/static/js/components/sidebar-navigation-controller.js

# Validate Jinja2 template syntax
# Flask will report syntax errors on page load - test by starting app

# Expected: Zero errors
```

### Level 2: Manual Testing (Component Validation)

```bash
# Start TickStockAppV2
python start_all_services.py

# Wait for startup
sleep 5

# Test 1: Index Comparison Page Load
# 1. Open http://localhost:5000 in browser
# 2. Click "Index Comparison" in sidebar
# 3. Verify 3 breadth metric columns visible (SPY, QQQ, dow30)
# 4. Verify each shows 12 metric rows
# 5. Check browser DevTools Network tab: 3 API calls to /api/breadth-metrics
# 6. Verify total page load time <500ms

# Test 2: Responsive Design
# 1. Open DevTools (F12) → Toggle device toolbar
# 2. Test at 1920px width: Verify 3 columns side-by-side
# 3. Test at 1200px width: Verify 3 columns side-by-side (breakpoint)
# 4. Test at 1199px width: Verify single column (stacked)
# 5. Test at 768px width: Verify single column (mobile)

# Test 3: Data Accuracy
# 1. Open browser DevTools → Network tab
# 2. Click on /api/breadth-metrics?universe=SPY request
# 3. View Response tab, note "up" count for "day_change" metric
# 4. Verify UI shows same count in SPY column, Day Chg row
# 5. Repeat for QQQ and dow30 columns

# Test 4: Auto-Refresh
# 1. Wait 60 seconds
# 2. Check Network tab: 3 new API calls should appear
# 3. Verify UI updates with new data (counts may change)

# Test 5: Regression - Market Breadth Page
# 1. Click "Market Breadth" in sidebar
# 2. Verify single instance renders with universe selector
# 3. Change universe from SPY to QQQ
# 4. Verify metrics update
# 5. Click refresh button, verify data updates

# Expected: All manual tests pass
```

### Level 3: Integration Testing (System Validation - MANDATORY)

```bash
# TickStock MANDATORY Integration Tests
python run_tests.py

# Expected Output:
# - 2+ tests passing
# - ~30 second runtime
# - Pattern flow tests passing
# - No new test failures (zero regression)

# NOTE: No new integration tests needed - feature is frontend-only
# Reuses existing Sprint 66 API infrastructure
```

### Level 4: TickStock-Specific Validation

```bash
# Performance Benchmarking
# Verify 3 parallel API calls complete in <500ms total

# Open browser DevTools → Network tab → Click "Index Comparison"
# Check timing for 3 /api/breadth-metrics requests:
# - SPY: ~80-100ms
# - QQQ: ~80-100ms
# - dow30: ~80-100ms
# Total (parallel): ~100ms (NOT 300ms sequential)

# Architecture Compliance Validation
# VERIFY: No database writes (feature is read-only)
# VERIFY: No Redis pub-sub (feature uses REST API only)
# VERIFY: No WebSocket broadcast (feature is request-response only)

# Code Quality Validation
# VERIFY: No "Generated by Claude" comments in code or commits
# VERIFY: File naming conventions followed (kebab-case)
# VERIFY: No linting errors (ruff check passes)
# VERIFY: No hardcoded data (all data from API)

# Documentation Validation
# VERIFY: Usage guide has 5+ clear examples
# VERIFY: Component API documents all parameters
# VERIFY: CLAUDE.md Sprint 67 entry complete

# Expected: All validations pass
```

## Final Validation Checklist

### Technical Validation

- [ ] Level 1 validation completed (syntax/style checks pass)
- [ ] Level 2 validation completed (all manual tests pass)
- [ ] Level 3 validation completed (integration tests pass, zero regression)
- [ ] Level 4 validation completed (performance, architecture, code quality)

### Feature Validation

- [ ] Index Comparison page loads with 3 breadth metric instances
- [ ] Each instance shows accurate data (verified against API responses)
- [ ] Page performance: <500ms total load time (3 parallel API calls)
- [ ] Responsive design: 3-column (desktop), stacked (mobile)
- [ ] Navigation: "Index Comparison" sidebar item works
- [ ] Zero regression: Existing Market Breadth page works identically

### TickStock Architecture Validation

- [ ] Component role respected (Consumer - read-only)
- [ ] No database writes (feature uses existing read-only API)
- [ ] No Redis pub-sub integration (feature is REST API only)
- [ ] Performance target met (<500ms page load)
- [ ] No architectural violations

### Code Quality Validation

- [ ] Follows existing codebase patterns (Sprint 66 reusable template pattern)
- [ ] File placement matches desired codebase tree
- [ ] No "Generated by Claude" comments in code or commits
- [ ] No linting errors (ruff check passes)
- [ ] Code structure limits followed (files <500 lines, functions <50 lines)
- [ ] Naming conventions: kebab-case files, PascalCase classes

### Documentation & Deployment

- [ ] Usage guide created with 5+ examples (market-breadth-usage.md)
- [ ] Component API reference created (components.md)
- [ ] CLAUDE.md updated with Sprint 67 entry
- [ ] Code is self-documenting with clear naming
- [ ] Documentation reviewed and accurate

---

## Anti-Patterns to Avoid

### Generic Anti-Patterns
- ❌ Don't create new backend services (reuse Sprint 66 API)
- ❌ Don't add new database queries (use existing endpoint)
- ❌ Don't hardcode data in templates (all data from API)
- ❌ Don't skip responsive testing (mobile breakpoints critical)

### TickStock-Specific Anti-Patterns

#### Template Anti-Patterns
- ❌ **Don't reuse instance_id across includes**
  - Violation: Using instance_id='default' for multiple instances
  - Result: DOM element collisions, only last instance works
  - Fix: Use unique instance_ids (spy, qqq, dow)

- ❌ **Don't forget show_controls=False for fixed displays**
  - Violation: Leaving show_controls=True (default) on Index Comparison page
  - Result: Universe selectors visible, users can change fixed column universes
  - Fix: Explicitly set show_controls=False

- ❌ **Don't skip IIFE closure for Jinja2 variables**
  - Violation: Using {{ instance_id }} directly in setTimeout()
  - Result: All instances share same variable values (last one wins)
  - Fix: Template already has IIFE - don't remove it

#### Navigation Anti-Patterns
- ❌ **Don't use generic component pattern for multi-instance pages**
  - Violation: Using lines 511-517 pattern (component.renderUI())
  - Result: Only first instance initializes, others fail
  - Fix: Use special content loader pattern (lines 471-495) with multiple init calls

- ❌ **Don't forget setTimeout delay for initialization**
  - Violation: Calling initialization functions immediately after innerHTML set
  - Result: DOM not ready, functions fail silently
  - Fix: Always use setTimeout(fn, 200) delay

#### Performance Anti-Patterns
- ❌ **Don't wait for sequential API calls**
  - Violation: await fetch1(); await fetch2(); await fetch3();
  - Result: 300ms+ total time (3 × 100ms sequential)
  - Fix: Renderer already uses async - no sequential waits needed

- ❌ **Don't create batch API "optimization" prematurely**
  - Violation: Creating /api/breadth-metrics/batch endpoint
  - Result: Increased complexity, minimal performance gain
  - Fix: 3 parallel calls (~100ms) is already fast enough

#### Documentation Anti-Patterns
- ❌ **Don't skip usage examples**
  - Violation: Only documenting parameters without showing how to use them
  - Result: Developers can't figure out how to implement multi-instance
  - Fix: Include 5+ clear examples (single, multi, embedded, custom)

- ❌ **Don't use invalid Jinja2 syntax in documentation**
  - Violation: {% include 'template.html' with var='value' %} (invalid syntax)
  - Result: Developers copy invalid code, get template errors
  - Fix: Use correct syntax: {% set var='value' %}{% include 'template.html' %}

---

## PRP Quality Assessment

**Context Completeness**: ✅ 95/100
- Sprint 66 implementation fully analyzed (415+257+225 lines reviewed)
- Sprint 64 comparison completed for pattern validation
- Template reusability pattern documented with critical gotchas
- Navigation integration pattern extracted from working example
- Performance characteristics validated (3 × <100ms = ~300ms)

**No Prior Knowledge Test**: ✅ PASS
- Contains all file paths, line numbers, and code patterns needed
- Documents critical gotchas (instance_id collisions, IIFE closures, setTimeout delays)
- Includes validation commands and expected outputs
- References existing working patterns to follow

**Information Density**: ✅ HIGH
- Implementation tasks include exact code to add with line number guidance
- All patterns include "CRITICAL" notes for non-obvious requirements
- Gotchas section documents common mistakes and solutions
- File structure shows exact placement for new files

**Dependency Ordering**: ✅ CORRECT
- Phase 1: Template/CSS (no dependencies)
- Phase 2: Navigation integration (depends on template existence)
- Phase 3: Documentation (depends on implementation complete)
- Phase 4: Testing (depends on all implementation complete)

**Validation Gates**: ✅ 4 LEVELS
- Level 1: Syntax validation (CSS/JS/Jinja2)
- Level 2: Manual testing (5 test scenarios)
- Level 3: Integration testing (python run_tests.py)
- Level 4: TickStock-specific (performance, architecture, code quality)

**Estimated Success Likelihood**: 90% one-pass implementation success

**Rationale**:
- Backend requires zero changes (Sprint 66 API already complete)
- Template reusability pattern already proven in Sprint 66
- Navigation integration follows exact working example (market-breadth loader)
- Only risk: Jinja2 syntax errors in multi-instance includes (mitigated by exact code examples)
- Documentation phase is straightforward (no code execution risks)
