# Sprint 52: Architecture & Data Flow Diagram

## System Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         TICKSTOCK ADMIN DASHBOARD (Sprint 52)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚  Browser / Admin UI â”‚
                            â”‚  (websockets.html)  â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                  â”‚                  â”‚
                    â–¼                  â–¼                  â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ GET /admin/         â”‚  â”‚ GET /api/    â”‚  â”‚ WebSocket    â”‚
        â”‚ websockets          â”‚  â”‚ admin/       â”‚  â”‚ /admin-ws    â”‚
        â”‚                     â”‚  â”‚ websocket-   â”‚  â”‚              â”‚
        â”‚ (HTML Template)     â”‚  â”‚ status (JSON)â”‚  â”‚ (Real-time   â”‚
        â”‚                     â”‚  â”‚              â”‚  â”‚  events)     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                     â”‚                 â”‚
                  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                  â”‚    â”‚                                  â”‚
                  â–¼    â–¼                                  â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚         FLASK APPLICATION (src/app.py)                  â”‚
        â”‚                                                         â”‚
        â”‚  Global References:                                    â”‚
        â”‚  - app: Flask                                          â”‚
        â”‚  - market_service: MarketDataService                   â”‚
        â”‚  - socketio: Flask-SocketIO                            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ market_service.data_adapter
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  MARKET DATA SERVICE (src/core/services/...)           â”‚
        â”‚                                                         â”‚
        â”‚  Properties:                                           â”‚
        â”‚  - data_adapter: RealTimeDataAdapter                   â”‚
        â”‚  - running: bool                                       â”‚
        â”‚  - stats: ServiceStats                                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ data_adapter.client
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                                         â”‚
        â”‚  REALITY CHECK: What is data_adapter.client?          â”‚
        â”‚                                                         â”‚
        â”‚  If USE_MULTI_CONNECTION=true:                         â”‚
        â”‚    â””â”€â–º MultiConnectionManager â—„â”€â”€ PRIMARY             â”‚
        â”‚                                                         â”‚
        â”‚  If USE_MULTI_CONNECTION=false:                        â”‚
        â”‚    â””â”€â–º MassiveWebSocketClient (single connection)      â”‚
        â”‚                                                         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  MULTI-CONNECTION MANAGER                              â”‚
        â”‚  (src/infrastructure/websocket/...)                    â”‚
        â”‚                                                         â”‚
        â”‚  âœ… THIS IS THE DATA SOURCE FOR SPRINT 52              â”‚
        â”‚                                                         â”‚
        â”‚  Key Properties:                                        â”‚
        â”‚  - connections: dict[str, ConnectionInfo]             â”‚
        â”‚  - total_ticks_received: int                           â”‚
        â”‚  - total_errors: int                                   â”‚
        â”‚                                                         â”‚
        â”‚  Key Methods:                                           â”‚
        â”‚  - get_health_status() â†’ dict (PRIMARY)               â”‚
        â”‚  - get_ticker_assignment(ticker) â†’ str|None           â”‚
        â”‚  - get_connection_tickers(conn_id) â†’ set[str]         â”‚
        â”‚  - connect() / disconnect()                            â”‚
        â”‚  - subscribe() / unsubscribe()                         â”‚
        â”‚                                                         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚              â”‚              â”‚
        â–¼                     â–¼              â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚Connection 1 â”‚  â”‚Connection 2   â”‚  â”‚Connection 3  â”‚  â”‚Metrics   â”‚
    â”‚  (primary)  â”‚  â”‚ (secondary)   â”‚  â”‚(tertiary)    â”‚  â”‚& Stats   â”‚
    â”‚             â”‚  â”‚               â”‚  â”‚              â”‚  â”‚          â”‚
    â”‚ Status: âœ…  â”‚  â”‚ Status: âœ…    â”‚  â”‚Status: âŒ   â”‚  â”‚ Total:   â”‚
    â”‚ Tickers:150 â”‚  â”‚ Tickers: 85   â”‚  â”‚Tickers: 0   â”‚  â”‚ Ticks:   â”‚
    â”‚ Msgs: 750   â”‚  â”‚ Msgs: 250     â”‚  â”‚ Msgs: 0     â”‚  â”‚ 1000     â”‚
    â”‚ Errors: 0   â”‚  â”‚ Errors: 5     â”‚  â”‚ Errors: 0   â”‚  â”‚ Errors:5 â”‚
    â”‚             â”‚  â”‚               â”‚  â”‚              â”‚  â”‚          â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                 â”‚                 â”‚
           â”‚                 â”‚                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚   Massive API WebSocket Connections             â”‚
    â”‚   (Each connection has independent ticker list) â”‚
    â”‚                                                  â”‚
    â”‚   Connection 1: â–“â–“â–“â–“â–“ (receiving data)          â”‚
    â”‚   Connection 2: â–“â–“â–“â–“â–“ (receiving data)          â”‚
    â”‚   Connection 3: (disabled)                       â”‚
    â”‚                                                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ Market tick events
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ REDIS CHANNEL               â”‚
    â”‚ tickstock:market:ticks      â”‚
    â”‚                             â”‚
    â”‚ Format: {                   â”‚
    â”‚   'type': 'market_tick',    â”‚
    â”‚   'symbol': 'AAPL',         â”‚
    â”‚   'price': 178.23,          â”‚
    â”‚   'volume': 50000,          â”‚
    â”‚   'timestamp': '...',       â”‚
    â”‚   'source': 'massive'       â”‚
    â”‚ }                           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ Admin WebSocket subscribes
             â”‚ to this channel
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ADMIN DASHBOARD (Browser)   â”‚
    â”‚                             â”‚
    â”‚ Column 1: Connection 1      â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚ â”‚ Status: ğŸŸ¢ Connected â”‚   â”‚
    â”‚ â”‚ Tickers: 150        â”‚   â”‚
    â”‚ â”‚ Rate: 25.3 msg/s    â”‚   â”‚
    â”‚ â”‚                     â”‚   â”‚
    â”‚ â”‚ AAPL  $178.23 â†‘     â”‚   â”‚
    â”‚ â”‚ NVDA  $495.67 â†‘     â”‚   â”‚
    â”‚ â”‚ TSLA  $248.91 â†’     â”‚   â”‚
    â”‚ â”‚ ...                 â”‚   â”‚
    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚                             â”‚
    â”‚ [Similar for Conn 2 & 3]   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Request/Response Flow Diagrams

### Flow 1: Initial Dashboard Load

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USER REQUESTS: GET /admin/websockets                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Flask Route Handler     â”‚
                    â”‚ @admin_required         â”‚
                    â”‚ render_template(...)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ web/templates/admin/    â”‚
                    â”‚ websockets.html         â”‚
                    â”‚                         â”‚
                    â”‚ <script>               â”‚
                    â”‚ fetch('/api/admin/     â”‚
                    â”‚   websocket-status')   â”‚
                    â”‚ </script>              â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ GET /api/admin/websocket-status    â”‚
                    â”‚ (Synchronous JSON response)        â”‚
                    â”‚                                     â”‚
                    â”‚ Step 1: Check auth                 â”‚
                    â”‚ Step 2: Get market_service         â”‚
                    â”‚ Step 3: Get data_adapter.client    â”‚
                    â”‚ Step 4: Call get_health_status()   â”‚
                    â”‚ Step 5: Transform response         â”‚
                    â”‚ Step 6: Return JSON                â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ HTTP 200 JSON Response  â”‚
                    â”‚                         â”‚
                    â”‚ {                       â”‚
                    â”‚  "connections": [       â”‚
                    â”‚    {                    â”‚
                    â”‚      "id": 1,           â”‚
                    â”‚      "status": "âœ…",    â”‚
                    â”‚      "ticker_count": 150â”‚
                    â”‚      ...                â”‚
                    â”‚    }                    â”‚
                    â”‚  ],                     â”‚
                    â”‚  "summary": {...}       â”‚
                    â”‚ }                       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Browser JavaScript     â”‚
                    â”‚ Renders Dashboard      â”‚
                    â”‚ with initial data      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Connect to WebSocket    â”‚
                    â”‚ io.connect('/admin-ws') â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Subscribe to Events:    â”‚
                    â”‚ - tick_update           â”‚
                    â”‚ - metrics_update        â”‚
                    â”‚ - status_update         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Dashboard Ready         â”‚
                    â”‚ (Real-time updates on) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Flow 2: Real-Time Tick Update

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MASSIVE API SENDS TICK DATA                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ MultiConnectionManager      â”‚
                    â”‚ receives tick from          â”‚
                    â”‚ Connection 1 (MassiveWS)    â”‚
                    â”‚                             â”‚
                    â”‚ Callback:                   â”‚
                    â”‚ _aggregate_tick_callback()  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚            â”‚            â”‚
                    â–¼            â–¼            â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Update stats:        â”‚
                  â”‚ - message_count += 1 â”‚
                  â”‚ - last_message_time  â”‚
                  â”‚   = time.time()      â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Call user_tick_      â”‚
                  â”‚ callback()           â”‚
                  â”‚                      â”‚
                  â”‚ (From DataPublisher) â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Publish to Redis:            â”‚
                  â”‚ Channel: tickstock:market:   â”‚
                  â”‚          ticks              â”‚
                  â”‚                              â”‚
                  â”‚ Message: {                   â”‚
                  â”‚   'symbol': 'AAPL',          â”‚
                  â”‚   'price': 178.23,           â”‚
                  â”‚   'timestamp': '...',        â”‚
                  â”‚   'source': 'massive'        â”‚
                  â”‚ }                            â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ADMIN WEBSOCKET HANDLER             â”‚
        â”‚ (Backend, /admin-ws namespace)      â”‚
        â”‚                                     â”‚
        â”‚ Subscribes to Redis channel         â”‚
        â”‚ Receives tick message               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Identify connection ID:        â”‚
        â”‚ (From manager state or lookup) â”‚
        â”‚                                â”‚
        â”‚ ticker_to_connection["AAPL"]   â”‚
        â”‚ â†’ "connection_1"              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Emit WebSocket event to        â”‚
        â”‚ all connected admins:          â”‚
        â”‚                                â”‚
        â”‚ socketio.emit(                 â”‚
        â”‚   'tick_update',               â”‚
        â”‚   {                            â”‚
        â”‚     'connection_id': 'conn_1', â”‚
        â”‚     'symbol': 'AAPL',          â”‚
        â”‚     'price': 178.23,           â”‚
        â”‚     'timestamp': '...'         â”‚
        â”‚   },                           â”‚
        â”‚   namespace='/admin-ws'        â”‚
        â”‚ )                              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Browser JavaScript receives    â”‚
        â”‚ tick_update event              â”‚
        â”‚                                â”‚
        â”‚ socket.on('tick_update',       â”‚
        â”‚   (data) => {                  â”‚
        â”‚     updateDashboard(data)      â”‚
        â”‚   }                            â”‚
        â”‚ )                              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Update Connection 1 column:    â”‚
        â”‚                                â”‚
        â”‚ - Add/update ticker row        â”‚
        â”‚ - Update price display         â”‚
        â”‚ - Update timestamp            â”‚
        â”‚ - Scroll list                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Admin sees real-time update    â”‚
        â”‚ on dashboard                   â”‚
        â”‚                                â”‚
        â”‚ AAPL  $178.23 â†‘ (updated)      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Flow 3: Periodic Metrics Update

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKGROUND TASK: Emit Metrics Every 1 Second                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Backend Timer (every 1sec)  â”‚
                    â”‚                             â”‚
                    â”‚ def broadcast_metrics():    â”‚
                    â”‚   while True:               â”‚
                    â”‚     time.sleep(1)           â”‚
                    â”‚     emit_updates()          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Get health status:           â”‚
                    â”‚ health = manager.            â”‚
                    â”‚   get_health_status()        â”‚
                    â”‚                              â”‚
                    â”‚ Returns: {                   â”‚
                    â”‚   connections: {             â”‚
                    â”‚     connection_1: {          â”‚
                    â”‚       message_count: 750,    â”‚
                    â”‚       error_count: 0,        â”‚
                    â”‚       status: 'connected'    â”‚
                    â”‚     },                       â”‚
                    â”‚     ...                      â”‚
                    â”‚   }                          â”‚
                    â”‚ }                            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Calculate metrics:           â”‚
                    â”‚                              â”‚
                    â”‚ elapsed_sec = time_since(    â”‚
                    â”‚   start_time                 â”‚
                    â”‚ )                            â”‚
                    â”‚                              â”‚
                    â”‚ msg_per_sec = health[...][  â”‚
                    â”‚   'message_count'            â”‚
                    â”‚ ] / elapsed_sec              â”‚
                    â”‚                              â”‚
                    â”‚ uptime = elapsed_sec         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Emit metrics_update to all   â”‚
                    â”‚ connected admin browsers:    â”‚
                    â”‚                              â”‚
                    â”‚ socketio.emit(               â”‚
                    â”‚   'metrics_update',          â”‚
                    â”‚   {                          â”‚
                    â”‚     connection_1: {          â”‚
                    â”‚       msgs_per_sec: 25.3,    â”‚
                    â”‚       uptime: 3600,          â”‚
                    â”‚       error_count: 0         â”‚
                    â”‚     },                       â”‚
                    â”‚     connection_2: {...},     â”‚
                    â”‚     connection_3: {...}      â”‚
                    â”‚   },                         â”‚
                    â”‚   namespace='/admin-ws'      â”‚
                    â”‚ )                            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Browser receives event:      â”‚
                    â”‚                              â”‚
                    â”‚ socket.on(                   â”‚
                    â”‚   'metrics_update',          â”‚
                    â”‚   (data) => {                â”‚
                    â”‚     updateMetrics(data)      â”‚
                    â”‚   }                          â”‚
                    â”‚ )                            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Update dashboard metrics:    â”‚
                    â”‚                              â”‚
                    â”‚ For each connection:         â”‚
                    â”‚ - msgs_per_sec counter      â”‚
                    â”‚ - uptime display            â”‚
                    â”‚ - error counter             â”‚
                    â”‚ - last_update timestamp     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Admin sees live metrics:     â”‚
                    â”‚                              â”‚
                    â”‚ Conn 1: 25.3 msg/s â†‘         â”‚
                    â”‚ Conn 2: 18.7 msg/s          â”‚
                    â”‚ Conn 3: N/A (disabled)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## State Machine: Connection Status

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CONNECTION STATUS STATE MACHINE                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  DISCONNECTED    â”‚ â† Initial state
                         â”‚  (status = '')   â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                     User calls connect()
                                  â”‚
                                  â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  CONNECTING      â”‚
                         â”‚  (status =       â”‚
                         â”‚   'connecting')  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                           â”‚
           Connection succeeds      Connection fails
                    â”‚                           â”‚
                    â–¼                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  CONNECTED           â”‚    â”‚  ERROR           â”‚
        â”‚  (status =           â”‚    â”‚  (status = 'error')
        â”‚   'connected')       â”‚    â”‚                  â”‚
        â”‚                      â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚  âœ… Ticking          â”‚             â”‚
        â”‚  âœ… Receiving msgs   â”‚             â”‚ (Will retry)
        â”‚  âœ… Metrics updating â”‚             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
                 â”‚                           â”‚
                 â”‚ User calls disconnect()  â”‚
                 â”‚                          â”‚
                 â–¼                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  DISCONNECTED                        â”‚
        â”‚  (status = 'disconnected')           â”‚
        â”‚                                      â”‚
        â”‚  âŒ No ticking                       â”‚
        â”‚  âŒ No msgs                          â”‚
        â”‚  âŒ message_count frozen             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Additional tracking:
- message_count: incremented every tick (if connected)
- error_count: incremented on errors
- last_message_time: updated when tick received
```

---

## Data Structure Hierarchy

```
MultiConnectionManager (Main Manager)
â”‚
â”œâ”€â”€ config: dict
â”‚   â”œâ”€â”€ USE_MULTI_CONNECTION: bool
â”‚   â”œâ”€â”€ WEBSOCKET_CONNECTIONS_MAX: int
â”‚   â”œâ”€â”€ WEBSOCKET_CONNECTION_1_ENABLED: bool
â”‚   â”œâ”€â”€ WEBSOCKET_CONNECTION_1_NAME: str
â”‚   â”œâ”€â”€ WEBSOCKET_CONNECTION_1_UNIVERSE_KEY: str
â”‚   â”œâ”€â”€ WEBSOCKET_CONNECTION_1_SYMBOLS: str
â”‚   â””â”€â”€ [repeat for connections 2, 3]
â”‚
â”œâ”€â”€ connections: dict[str, ConnectionInfo]
â”‚   â”‚
â”‚   â”œâ”€â”€ "connection_1" â†’ ConnectionInfo
â”‚   â”‚   â”œâ”€â”€ connection_id: "connection_1"
â”‚   â”‚   â”œâ”€â”€ name: "primary"
â”‚   â”‚   â”œâ”€â”€ client: MassiveWebSocketClient instance
â”‚   â”‚   â”œâ”€â”€ assigned_tickers: {"AAPL", "NVDA", "TSLA", ...}
â”‚   â”‚   â”œâ”€â”€ status: "connected" | "disconnected" | "connecting" | "error"
â”‚   â”‚   â”œâ”€â”€ message_count: 750
â”‚   â”‚   â”œâ”€â”€ error_count: 0
â”‚   â”‚   â””â”€â”€ last_message_time: 1705853696.123
â”‚   â”‚
â”‚   â”œâ”€â”€ "connection_2" â†’ ConnectionInfo {...}
â”‚   â”‚
â”‚   â””â”€â”€ "connection_3" â†’ ConnectionInfo {...}
â”‚
â”œâ”€â”€ ticker_to_connection: dict[str, str]
â”‚   â”œâ”€â”€ "AAPL" â†’ "connection_1"
â”‚   â”œâ”€â”€ "NVDA" â†’ "connection_1"
â”‚   â”œâ”€â”€ "TSLA" â†’ "connection_1"
â”‚   â”œâ”€â”€ "JPM" â†’ "connection_2"
â”‚   â”œâ”€â”€ "BAC" â†’ "connection_2"
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ _user_tick_callback: Callable
â”‚   â””â”€â”€ Called for every tick received from any connection
â”‚
â”œâ”€â”€ _user_status_callback: Callable
â”‚   â””â”€â”€ Called for every status update from any connection
â”‚
â”œâ”€â”€ _lock: threading.RLock
â”‚   â””â”€â”€ Protects connections dict and statistics during updates
â”‚
â”œâ”€â”€ total_ticks_received: int (across all connections)
â”‚
â””â”€â”€ total_errors: int (across all connections)
```

---

## Thread Safety Model

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              THREAD SAFETY: RLock Protection                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Multiple Threads Can Read Simultaneously:

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Flask Route #1  â”‚         â”‚ Flask Route #2   â”‚
   â”‚ (Admin request) â”‚         â”‚ (Admin request)  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                          â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                    â”‚ Acquire     â”‚
                    â”‚ RLock.read  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Read: connections dict          â”‚
          â”‚ Read: message_count             â”‚
          â”‚ Read: status                    â”‚
          â”‚ (Safe - no concurrent writes)   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Release RLock   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Write Protected by RLock:

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ WebSocket Tick Arrived  â”‚
   â”‚ (from connection)       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Callback:               â”‚
   â”‚ _aggregate_tick_        â”‚
   â”‚ callback()              â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Acquire RLock.write     â”‚
   â”‚ (Exclusive)             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Update atomically: â”‚
  â”‚ - message_count+=1 â”‚
  â”‚ - last_msg_time    â”‚
  â”‚   = time.time()    â”‚
  â”‚ (Only writer now)  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Release RLock     â”‚
   â”‚ (Readers can go)  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Consequence: get_health_status() is ALWAYS safe to call from any thread
```

---

## Configuration Precedence

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WEBSOCKET_CONNECTION_1 Configuration Resolution            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: Check if enabled
   ENV: WEBSOCKET_CONNECTION_1_ENABLED
        â”‚
        â”œâ”€ true  â†’ Continue
        â”œâ”€ false â†’ Skip this connection, mark disabled
        â””â”€ missing â†’ Default to false

Step 2: Get connection name
   ENV: WEBSOCKET_CONNECTION_1_NAME
        â”‚
        â”œâ”€ value found â†’ Use it (e.g., "primary")
        â””â”€ missing â†’ Generate default (e.g., "connection_1")

Step 3: Load tickers (Priority order)
   
   3A. Try Universe Key (PREFERRED)
       ENV: WEBSOCKET_CONNECTION_1_UNIVERSE_KEY
            â”‚
            â”œâ”€ value found (e.g., "market_leaders:top_500")
            â”‚  â”œâ”€ Query CacheControl
            â”‚  â”œâ”€ Get ticker list
            â”‚  â””â”€ Return tickers
            â”‚
            â””â”€ missing/empty â†’ Continue to 3B

   3B. Try Direct Symbols (FALLBACK)
       ENV: WEBSOCKET_CONNECTION_1_SYMBOLS
            â”‚
            â”œâ”€ value found (e.g., "AAPL,NVDA,TSLA")
            â”‚  â”œâ”€ Parse comma-separated
            â”‚  â”œâ”€ Trim whitespace
            â”‚  â””â”€ Return tickers
            â”‚
            â””â”€ missing/empty â†’ Continue to 3C

   3C. No configuration found
       â””â”€ Log warning, return empty list []
```

---

## Dependency Graph

```
Sprint 52 Dashboard Implementation
    â”‚
    â”œâ”€â–º MultiConnectionManager
    â”‚       â”œâ”€â–º MassiveWebSocketClient (x3)
    â”‚       â”‚       â””â”€â–º Massive API WebSocket
    â”‚       â”‚
    â”‚       â””â”€â–º ConnectionInfo (dataclass)
    â”‚
    â”œâ”€â–º RealTimeDataAdapter
    â”‚       â”œâ”€â–º MultiConnectionManager or MassiveWebSocketClient
    â”‚       â”œâ”€â–º DataPublisher
    â”‚       â””â”€â–º WebSocketPublisher
    â”‚
    â”œâ”€â–º MarketDataService
    â”‚       â”œâ”€â–º RealTimeDataAdapter
    â”‚       â”œâ”€â–º DataPublisher
    â”‚       â””â”€â–º WebSocketPublisher
    â”‚
    â”œâ”€â–º Flask Routes
    â”‚       â”œâ”€â–º MarketDataService (global)
    â”‚       â”œâ”€â–º RealTimeDataAdapter
    â”‚       â””â”€â–º MultiConnectionManager.get_health_status()
    â”‚
    â”œâ”€â–º WebSocket Events (/admin-ws)
    â”‚       â”œâ”€â–º Redis channels (tickstock:market:ticks)
    â”‚       â””â”€â–º Browser clients
    â”‚
    â””â”€â–º Frontend Template (websockets.html)
            â”œâ”€â–º Bootstrap CSS
            â”œâ”€â–º JavaScript WebSocket client
            â””â”€â–º Chart.js (optional, for metrics)
```

---

## Performance Characteristics

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Latency Breakdown: User Action â†’ Update Display            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Scenario 1: Initial Dashboard Load
   User clicks /admin/websockets
   â”‚
   â”œâ”€ Flask routing:           ~5ms
   â”œâ”€ Template rendering:     ~50ms
   â”œâ”€ Browser fetch config:   ~100ms
   â”œâ”€ API query endpoint:     ~50ms
   â”‚  â”œâ”€ Import market_service:  2ms
   â”‚  â”œâ”€ Get data_adapter.client: 1ms
   â”‚  â”œâ”€ Call get_health_status(): 5ms
   â”‚  â”œâ”€ JSON serialization:      2ms
   â”‚  â””â”€ Network round-trip:     40ms
   â”‚
   â”œâ”€ Browser renders:        ~100ms
   â””â”€ TOTAL:                  ~305ms (target <2000ms) âœ…

Scenario 2: Real-Time Tick Update
   Massive API sends tick to Connection 1
   â”‚
   â”œâ”€ WebSocket receive:      ~10ms
   â”œâ”€ Callback trigger:       ~1ms
   â”œâ”€ Stats update (locked):  ~1ms
   â”œâ”€ Publish to Redis:       ~5ms
   â”œâ”€ Admin WebSocket reads:  ~10ms
   â”œâ”€ Emit to browser:        ~20ms
   â”œâ”€ Network delivery:       ~50ms
   â”œâ”€ Browser JS process:     ~20ms
   â”œâ”€ DOM update:             ~50ms
   â””â”€ TOTAL:                  ~167ms (target <500ms) âœ…

Scenario 3: Periodic Metrics Broadcast (1x/sec)
   Backend timer fires
   â”‚
   â”œâ”€ Get health_status():    ~5ms
   â”œâ”€ Calculate metrics:      ~2ms
   â”œâ”€ Serialize JSON:         ~1ms
   â”œâ”€ Emit to 5 admins:       ~10ms
   â”œâ”€ Network delivery:       ~50ms
   â”œâ”€ Browser JS process:     ~5ms
   â”œâ”€ DOM update:             ~20ms
   â””â”€ TOTAL:                  ~93ms per broadcast âœ…
   
   (1 broadcast/sec = 93ms / 1000ms = 9% overhead) âœ…


Memory Usage:
   ConnectionInfo (per conn): ~1KB
   For 3 connections:         ~3KB
   Ticker set (150 tickers):  ~2KB
   Total overhead:            ~5KB (negligible)
```

---

This architecture ensures the Sprint 52 dashboard can:
- Query connection status <10ms (locally)
- Receive real-time updates <200ms (network included)
- Display metrics updates <100ms
- Support 300+ concurrent ticker displays
- Maintain zero impact on production WebSocket throughput
