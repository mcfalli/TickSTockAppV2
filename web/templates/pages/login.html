<!DOCTYPE html>
<html>
<head>
    <title>Login - TickStock</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
    <style>
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            color: #dc3545;
            margin-bottom: 10px;
        }
        
        .modal-body {
            margin-bottom: 25px;
            line-height: 1.5;
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .btn-modal {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            min-width: 100px;
        }
        
        .btn-modal.primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-modal.primary:hover {
            background-color: #0056b3;
        }
        
        .btn-modal.secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-modal.secondary:hover {
            background-color: #545b62;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            FingerprintJS.load().then(fp => {
                fp.get().then(result => {
                    const fingerprintData = {
                        visitorId: result.visitorId,
                        os: result.components.os ? result.components.os.value : 'unknown',
                        browser: result.components.browser ? result.components.browser.value : 'unknown',
                        screen_resolution: `${window.screen.width}x${window.screen.height}`,
                        canvas: result.components.canvas ? result.components.canvas.value : 'unknown',
                        fonts: result.components.fonts ? result.components.fonts.value : [],
                        plugins: result.components.plugins ? result.components.plugins.value : [],
                        timezone: result.components.timezone ? result.components.timezone.value : 'unknown'
                    };
                    document.getElementById('fingerprint_data').value = JSON.stringify(fingerprintData);
                    console.log('Fingerprint data:', fingerprintData);
                });
            });
            
            // Show renewal modal if needed
            const showModal = '{{ show_renewal_modal or "" }}' === 'True';
            if (showModal) {
                document.getElementById('renewalModal').classList.add('show');
            }
        });
        
        function confirmRenewal(decision) {
            // Create form and submit decision
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("confirm_renewal") }}';
            
            // Add CSRF token
            const csrfToken = document.querySelector('input[name="csrf_token"]').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
            
            // Add decision
            const decisionInput = document.createElement('input');
            decisionInput.type = 'hidden';
            decisionInput.name = 'decision';
            decisionInput.value = decision;
            form.appendChild(decisionInput);
            
            document.body.appendChild(form);
            form.submit();
        }
    </script>
</head>
<body>
    <div class="navbar">
        <h1>TickStock</h1>
        <div class="navbar-right">
            <span class="support-email">support@tickstock.com</span>
        </div>
    </div>
    <div class="container">
        <div class="auth-panel">
            <h2>Login</h2>
            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    <ul class="flash-messages">
                        {% for message in messages %}
                            <li>{{ message }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            {% endwith %}
            <form method="POST">
                {{ form.hidden_tag() }}
                <div class="form-group">
                    <label for="email">Email:</label>
                    {{ form.email(class="form-control") }}
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    {{ form.password(class="form-control") }}
                </div>
                <div class="form-group">
                    <label>{{ form.captcha_response }} I am not a robot (stub)</label>
                </div>
                <div class="form-group terms-checkbox">
                    <label>{{ form.terms_accepted }} I accept the <a href="{{ url_for('terms_and_conditions') }}" target="_blank">Terms and Conditions</a> <span class="required">*</span></label>
                    {% if form.terms_accepted.errors %}
                        <div class="error">
                            {% for error in form.terms_accepted.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                {{ form.fingerprint_data(class="form-control", type="hidden") }}
                {{ form.submit(class="btn btn-primary") }}
            </form>
            <p>Need an account? <a href="{{ url_for('register') }}">Register</a></p>
            <p>Forgot password? <a href="{{ url_for('initiate_password_reset') }}">Reset Password</a></p>
        </div>
    </div>
    
    <!-- Renewal Confirmation Modal -->
    <div id="renewalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Subscription Expired</h3>
            </div>
            <div class="modal-body">
                <p>Your subscription has expired, but your login credentials are valid.</p>
                <p><strong>Would you like to renew your subscription?</strong></p>
                <p><small>If you choose yes, we'll verify your identity with a code sent to your phone for security.</small></p>
            </div>
            <div class="modal-buttons">
                <button class="btn-modal primary" onclick="confirmRenewal('yes')">
                    Yes, Renew My Subscription
                </button>
                <button class="btn-modal secondary" onclick="confirmRenewal('no')">
                    Not Right Now
                </button>
            </div>
        </div>
    </div>
    
    <div class="status-bar">
        <div class="status-bar-left">
            <small>Â© 2025 TickStock</small>
        </div>
    </div>
</body>
</html>